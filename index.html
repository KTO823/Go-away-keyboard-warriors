<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…¸æ°‘èµ°é–‹ï½œç¤¾ç¾¤åª’é«”éµç›¤å¤§æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Firebase SDKs for Persistence -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <script defer>
        // ----------------------------------------------------------------------
        // API Key è¨­å®š
        // ----------------------------------------------------------------------
        let apiKey = ""; 
        
        // ----------------------------------------------------------------------
        // Firebase è¨­å®šèˆ‡åˆå§‹åŒ–é‚è¼¯
        // ----------------------------------------------------------------------
        if (typeof firebase !== 'undefined' && firebase.firestore) {
            firebase.firestore.setLogLevel('Debug');
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        try {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            firebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }
        
        window.db = null;
        window.auth = null;
        window.userId = 'è¼‰å…¥ä¸­...'; 
        
        window.firebaseSetup = async () => {
            if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                window.userId = 'SDK éŒ¯èª¤';
                updateUserDisplay();
                return;
            }

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    window.userId = 'è¨ªå®¢æ¨¡å¼';
                    updateUserDisplay();
                    return;
                }
                
                const app = firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore(app);
                window.auth = firebase.auth(app);

                firebase.auth(app).onAuthStateChanged(async (user) => {
                    if (user) {
                        window.userId = user.uid.substring(0, 8).toUpperCase();
                    } else {
                        try {
                            if (initialAuthToken) {
                                const userCredential = await firebase.auth(app).signInWithCustomToken(initialAuthToken);
                                window.userId = userCredential.user.uid.substring(0, 8).toUpperCase();
                            } else {
                                const userCredential = await firebase.auth(app).signInAnonymously();
                                window.userId = userCredential.user.uid.substring(0, 8).toUpperCase();
                            }
                        } catch (error) {
                            window.userId = 'é©—è­‰å¤±æ•—';
                        }
                    }
                    updateUserDisplay();
                });
            } catch (setupError) {
                window.userId = 'è¨­å®šå¤±æ•—';
                updateUserDisplay();
            }
        };

        function updateUserDisplay() {
            const idDisplayEl = document.getElementById('user-id-display');
            if(idDisplayEl) { idDisplayEl.textContent = `ID: ${window.userId}`; }
        }

        window.firebaseSetup();
    </script>
    <style>
        /* å­—é«”ï¼šç¾ä»£åœ“æ½¤ç„¡è¥¯ç·šé«” */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Nunito:wght@400;600;700;800&display=swap');
        
        :root {
            /* æŸ”å’Œç§‘æŠ€é…è‰² - çµ±ä¸€è‰²èª¿ */
            --bg-deep: #0b1120;       /* æ›´æ·±çš„ Slate */
            --panel-bg: rgba(30, 41, 59, 0.4); 
            
            --accent-primary: #10b981; /* Emerald */
            --accent-glow: rgba(16, 185, 129, 0.5);
            
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-shine: 1px solid rgba(255, 255, 255, 0.15);
        }

        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }

        /* èƒŒæ™¯å‹•æ…‹å…‰æšˆ - æ¨¡æ“¬æ¥µå…‰/æ·±æµ·å…‰ */
        body::before, body::after {
            content: '';
            position: fixed;
            width: 60vw;
            height: 60vw;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.15;
            z-index: -1;
            animation: floatLight 20s infinite alternate ease-in-out;
        }
        body::before {
            background: radial-gradient(circle, #10b981, transparent 70%);
            top: -10%;
            left: -10%;
        }
        body::after {
            background: radial-gradient(circle, #3b82f6, transparent 70%); /* Blue hint */
            bottom: -10%;
            right: -10%;
            animation-delay: -10s;
        }

        @keyframes floatLight {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(10%, 10%) scale(1.1); }
        }

        /* æ¨™é¡Œèˆ‡é‡é»æ–‡å­— - åŠ å¼·å…‰æšˆ */
        h1, h2, h3 {
            font-weight: 800;
            letter-spacing: -0.025em;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.3); /* æŸ”å’Œç¶ å…‰ */
        }

        /* ä¸»å®¹å™¨ï¼šç»ç’ƒæ“¬æ…‹ + é‚Šç·£å…‰ */
        .arena-bg {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: var(--glass-border);
            border-top: var(--glass-shine); /* é ‚éƒ¨é«˜å…‰ */
            border-left: var(--glass-shine); /* å·¦å´é«˜å…‰ */
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.6), 
                0 0 40px rgba(16, 185, 129, 0.05); /* å¤–éƒ¨å¾®å…‰ */
            border-radius: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        /* å®¹å™¨å…§éƒ¨çš„å¾®å¼±ç¶²æ ¼ç´‹ç† */
        .arena-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            opacity: 0.5;
            mask-image: linear-gradient(to bottom, rgba(0,0,0,1), rgba(0,0,0,0));
        }

        /* å¡ç‰‡æ¨£å¼ï¼šæ‡¸æµ®å…‰æ„Ÿ */
        .card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.25rem;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            z-index: 10;
        }
        .card:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.15); /* ç¶ è‰²å…‰æšˆ */
            transform: translateY(-4px);
        }
        
        /* æŒ‰éˆ•åŸºç¤ - ç»ç’ƒè³ªæ„Ÿ */
        .btn-base {
            transition: all 0.3s ease;
            border-radius: 1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            display: inline-flex; align-items: center; justify-content: center;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .btn-base::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .btn-base:hover::after { opacity: 1; }
        .btn-base:active:not(:disabled) { transform: scale(0.98); }
        .btn-base:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(0.8); }

        /* ä¸»è¦æŒ‰éˆ• (Emerald Glow) */
        .soft-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-top: 1px solid rgba(52, 211, 153, 0.4);
            color: #ecfdf5;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        .soft-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
            text-shadow: 0 0 8px rgba(255,255,255,0.5);
        }
        
        /* æ¬¡è¦æŒ‰éˆ• (Indigo Glow) */
        .soft-btn-secondary {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #e0e7ff;
        }
        .soft-btn-secondary:hover:not(:disabled) {
            background: rgba(99, 102, 241, 0.2);
            border-color: #818cf8;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
            color: white;
        }

        /* å±éšªæŒ‰éˆ• (Red Glow) */
        .soft-btn-danger {
            background: rgba(127, 29, 29, 0.4);
            border: 1px solid rgba(244, 63, 94, 0.3);
            color: #ffe4e6;
        }
        .soft-btn-danger:hover:not(:disabled) {
            background: rgba(225, 29, 72, 0.2);
            border-color: #fb7185;
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.3);
            color: white;
        }
        
        /* å°å·¥å…·æŒ‰éˆ• (Halo Effect) */
        .util-btn {
            border-radius: 50%; width: 3rem; height: 3rem;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-sub);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .util-btn:hover {
            background: var(--text-main);
            color: var(--bg-deep);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* å½ˆå‡ºè¦–çª— (Modal) - èšç„¦å…‰æ•ˆ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(5, 10, 20, 0.85); /* å¾ˆæ·±çš„èƒŒæ™¯ */
            backdrop-filter: blur(12px);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.4s ease-out;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(16, 185, 129, 0.3); /* ç¶ è‰²é‚Šæ¡†å…‰ */
            box-shadow: 0 0 50px rgba(16, 185, 129, 0.15); /* å¤§ç¯„åœå…‰æšˆ */
            border-radius: 2rem;
            padding: 2.5rem;
            max-width: 90%; width: 600px;
            max-height: 85vh; overflow-y: auto;
            position: relative;
            animation: floatUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floatUp { 
            from { opacity: 0; transform: translateY(20px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0; transform: translateY(15px);
        }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        /* å°è©±æ°£æ³¡ - ç™¼å…‰é‚Šç·£ */
        .dialog-bubble {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--accent-primary); /* å·¦å´ç™¼å…‰æ¢ */
            border-radius: 1rem; border-top-left-radius: 2px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ - å…§ç™¼å…‰ */
        input, textarea {
            background: rgba(2, 6, 23, 0.5) !important;
            border: 1px solid rgba(148, 163, 184, 0.2) !important;
            border-radius: 1rem !important;
            color: var(--text-main) !important;
            font-family: inherit !important;
            transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none !important;
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15) !important;
            background: rgba(2, 6, 23, 0.8) !important;
        }

        /* é—œéµå­—æ¨™ç±¤ */
        .glossary-term {
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.2);
            padding: 4px 12px; border-radius: 999px;
            font-size: 0.85em; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0);
        }
        .glossary-term:hover {
            background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); /* ç™¼å…‰ */
            border-color: #34d399;
            color: #fff;
        }
        
        /* é›£åº¦é¸æ“‡æŒ‰éˆ• - æŸ”å’Œç§‘æŠ€é¢¨æ ¼ */
        .soft-btn-difficulty {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-sub);
            border-radius: 1rem;
            transition: all 0.3s;
        }
        .soft-btn-difficulty:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.3);
            color: var(--text-main);
        }
        .soft-btn-difficulty.selected {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.15);
        }

        strong { color: #fcd34d; font-weight: 700; text-shadow: 0 0 10px rgba(252, 211, 77, 0.3); }
        .text-accent { color: var(--accent-primary); }
        
        /* æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(16, 185, 129, 0.5); }

        /* Loading Spinner - èƒ½é‡ç’° */
        .loader {
            border: 4px solid rgba(16, 185, 129, 0.1);
            border-top-color: #34d399;
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            filter: drop-shadow(0 0 8px #34d399);
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

    <!-- Introduction Modal -->
    <div id="intro-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <div class="mb-8 relative">
                <!-- å…‰æ•ˆè£é£¾ -->
                <div class="absolute inset-0 bg-emerald-500/20 blur-3xl rounded-full -z-10"></div>
                <div class="text-7xl mb-4 animate-bounce drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">ğŸ›¡ï¸</div>
                <h2 class="text-3xl font-black text-white mb-1 tracking-tight">æ­¡è¿ä¾†åˆ°ã€Œéµç›¤æˆ°å ´ã€</h2>
                <p class="text-emerald-400 text-sm font-bold tracking-[0.3em] uppercase">Logic Defense System v2.0</p>
            </div>

            <div class="space-y-6 text-slate-300 text-left bg-slate-900/40 p-8 rounded-3xl border border-white/5 backdrop-blur-md">
                <p class="leading-relaxed text-lg">
                    ç¤¾ç¾¤æ™‚ä»£ï¼Œ<strong class="text-amber-400">é‚è¼¯å·²æ­»ï¼Œæƒ…ç·’ç•¶é“</strong>ã€‚<br>
                    ä½ æ˜¯ç¢©æœåƒ…å­˜çš„ã€Œé‚è¼¯é˜²è¡›è€…ã€ï¼Œä»»å‹™æ˜¯æ·¨åŒ–é€™å€‹å……æ»¿è¬¬èª¤çš„æ•¸ä½ä¸–ç•Œã€‚
                </p>
                <div class="grid gap-3 text-sm">
                    <div class="flex items-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-emerald-500/30 transition-colors">
                        <span class="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center font-bold mr-4">1</span>
                        <span><strong>é‚è¼¯æ‹†è§£</strong>ï¼šå€åˆ†äº‹å¯¦èˆ‡è§€é»ã€‚</span>
                    </div>
                    <div class="flex items-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-indigo-500/30 transition-colors">
                        <span class="w-8 h-8 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center font-bold mr-4">2</span>
                        <span><strong>è§’è‰²æ¨¡æ“¬</strong>ï¼šæ›ä½æ€è€ƒï¼Œæ¨¡ä»¿ä¸åŒç«‹å ´ã€‚</span>
                    </div>
                    <div class="flex items-center p-3 rounded-xl bg-white/5 border border-white/5 hover:border-rose-500/30 transition-colors">
                        <span class="w-8 h-8 rounded-full bg-rose-500/20 text-rose-400 flex items-center justify-center font-bold mr-4">3</span>
                        <span><strong>é­”ç‹å°æ±º</strong>ï¼šæ“Šæ½°ç„¡è¦–å…§æ–‡çš„é…¸æ°‘ã€‚</span>
                    </div>
                </div>
            </div>

            <button id="close-intro-btn" class="mt-8 soft-btn btn-base py-4 px-12 text-xl w-full shadow-emerald-500/20 hover:scale-[1.02] transform transition">
                é€²å…¥æˆ°å ´
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="modal-overlay hidden flex-col">
        <div class="relative w-20 h-20 mb-6">
            <div class="w-full h-full loader"></div>
        </div>
        <p id="loading-message" class="text-emerald-300 text-xl font-bold tracking-widest animate-pulse drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]">AI é‹ç®—ä¸­...</p>
    </div>

    <div id="game-container" class="w-full max-w-5xl arena-bg p-6 md:p-12 relative">
        
        <!-- Header -->
        <header class="mb-10 flex flex-col md:flex-row justify-between items-center relative border-b border-white/10 pb-8">
            <div class="text-center md:text-left">
                <h1 class="text-4xl md:text-5xl font-black text-white tracking-tighter mb-3 drop-shadow-md">
                    <span class="mr-2">ğŸ§ </span> éµç›¤å¤§æˆ° <span class="text-slate-600 font-thin text-3xl mx-3">|</span> <span class="text-slate-200">é…¸æ°‘èµ°é–‹</span>
                </h1>
                <div class="flex items-center justify-center md:justify-start gap-4 mt-2">
                    <span id="current-stage-display" class="bg-emerald-500/10 text-emerald-400 px-4 py-1.5 rounded-full text-xs font-bold tracking-widest uppercase border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)]">ç³»çµ±å°±ç·’</span>
                    <p id="user-id-display" class="text-xs text-slate-500 font-mono tracking-wider">ID: ...</p>
                </div>
            </div>

            <!-- Tools -->
            <div class="flex space-x-4 mt-6 md:mt-0">
                <button id="bgm-toggle" class="util-btn" aria-label="Toggle BGM" title="èƒŒæ™¯éŸ³æ¨‚">
                    â™«
                </button>
                <button id="instructions-button" class="util-btn" aria-label="Instructions" title="èªªæ˜">
                    ?
                </button>
            </div>
        </header>

        <!-- (Legacy Error - now handled by Modal) -->
        <div id="error-state" class="hidden"></div>

        <!-- Sticky Scenario (Persistent) -->
        <div id="scenario-display-container" class="hidden mb-10 fade-in-up">
            <div class="bg-slate-900/40 border border-slate-700/50 rounded-3xl p-6 relative overflow-hidden group hover:border-slate-600/80 transition-colors">
                <!-- å·¦å´ç™¼å…‰è£é£¾ -->
                <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-emerald-400 to-transparent shadow-[0_0_15px_#34d399]"></div>
                
                <h3 class="text-sm font-bold text-emerald-400 mb-4 flex items-center tracking-wide uppercase">
                    <span class="mr-3 text-xl bg-emerald-500/20 w-8 h-8 rounded-lg flex items-center justify-center">ğŸ“„</span> ç›®å‰è­°é¡Œ (Target Post)
                </h3>
                <div id="scenario-content-display" class="p-5 bg-black/20 rounded-2xl border border-white/5 max-h-56 overflow-y-auto text-lg text-slate-300 leading-relaxed whitespace-pre-wrap font-medium shadow-inner">
                    <!-- Content injected -->
                </div>
            </div>
        </div>


        <!-- Game Content Area -->
        <div id="game-content" class="min-h-[300px]">
            
            <!-- Stage 0: Setup -->
            <div id="stage-0" class="space-y-6"></div>

            <!-- Stage 1: Logic Analysis -->
            <div id="stage-1" class="hidden"></div>

            <!-- Stage 2: Logic Result (Review) -->
            <div id="stage-2" class="hidden"></div>

            <!-- Stage 3: Role Simulation (Role Play) -->
            <div id="stage-3" class="hidden"></div>

            <!-- Stage 4: Community Observation -->
            <div id="stage-4" class="hidden"></div>

            <!-- Stage 5: Boss Battle -->
            <div id="stage-5" class="hidden"></div>

            <!-- Stage 6: Evaluation -->
            <div id="stage-6" class="hidden"></div>
            
        </div>

    </div>
    
    <!-- Modal Container for Dynamic Popups -->
    <div id="modal-container"></div>

    <script defer>
        // ----------------------------------------------------
        // 1. Config & Difficulty Settings
        // ----------------------------------------------------
        
        let MAX_DEBATE_ROUNDS = 4;

        // é›£åº¦è¨­å®š
        const DIFFICULTY_SETTINGS = {
            EASY: {
                key: 'EASY',
                name: "éµç›¤å°å±å­©",
                description: "å£æ¢å·® / ä¸€å—†å°±å€’",
                icon: "ğŸ‘¶",
                moraleMultiplier: 0.4, // å—å‚·å€ç‡é«˜ (å®¹æ˜“è¢«æ‰£å£«æ°£)
                winThreshold: 0.3 // é–€æª»ä½
            },
            MEDIUM: {
                key: 'MEDIUM',
                name: "ç¤¾ç¾¤å˜´ç ²ç‹",
                description: "æ­£å¸¸çˆ­è«– / æœ‰ä¾†æœ‰å¾€",
                icon: "ğŸ—£ï¸",
                moraleMultiplier: 0.7, // åŸç‚º 1.0ï¼Œèª¿ä½å€ç‡è®“ç©å®¶æ›´å®¹æ˜“é€ æˆå‚·å®³ (Damage = X / 0.7 = 1.4å€)
                winThreshold: 0.6
            },
            HARD: {
                key: 'HARD',
                name: "å°ˆå®¶è¾¯è«–å®¶",
                description: "ä¸€èˆ¬è¾¯è«–ç­‰ç´š / é‚è¼¯åš´è¬¹",
                icon: "ğŸ§ ",
                moraleMultiplier: 1.5, // å—å‚·å€ç‡ä½ (å¾ˆé›£æ‰£å£«æ°£)
                winThreshold: 0.8 
            }
        };

        const gameState = {
            currentStage: 0, 
            scenario: '',          
            scenarioCategory: '',  
            gameData: null,        
            userFactChecks: null,  
            fojScore: 0,           
            glossary: {},          
            
            assignedRoleIndex: null, 
            userRoleArgument: null,  
            rolePlayCritique: null,  

            difficulty: 'MEDIUM',    
            bossCharacter: null,     
            debateHistory: [],       
            bossMorale: 100,         
            gameMode: 'rounds', 
            isSurrender: false,

            evaluation: null
        };
        
        let stageDisplay, gameContent, loadingState, errorState, loadingMessage;
        let stages = {};

        function parseText(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-amber-400 drop-shadow-[0_0_5px_rgba(251,191,36,0.5)]">$1</strong>');
        }

        // ----------------------------------------------------
        // 2. Audio (Tone.js) - Soft Tech Ambient
        // ----------------------------------------------------
        
        // Revert to softer sounds
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" }, 
            envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 }
        }).toDestination();
        synth.volume.value = -6;

        const clickSynth = new Tone.MembraneSynth().toDestination();
        clickSynth.volume.value = -12;

        const bgmPad = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.5, decay: 0.5, sustain: 0.5, release: 2 }
        }).toDestination();
        bgmPad.volume.value = -15;

        let bgmLoop = null;
        let isAudioInitialized = false;
        let isBGMPlaying = false;

        function playClickSFX() {
            if (isAudioInitialized) clickSynth.triggerAttackRelease("C2", "32n");
        }

        function playSuccessSFX() {
            if (isAudioInitialized) {
                synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n");
            }
        }

        function playFailureSFX() {
            if (isAudioInitialized) {
                synth.triggerAttackRelease(["A3", "E3", "C3"], "8n");
            }
        }
        
        function playBossResponseSFX() {
            if (isAudioInitialized) synth.triggerAttackRelease(["G2", "D3"], "8n");
        }

        function startBGM() {
            if (!isAudioInitialized || isBGMPlaying) return;

            const chords = [
                ["C3", "E3", "G3", "B3"],
                ["A2", "C3", "E3", "G3"],
                ["F2", "A2", "C3", "E3"],
                ["G2", "B2", "D3", "F3"]
            ];
            let chordIndex = 0;

            bgmLoop = new Tone.Loop(time => {
                bgmPad.triggerAttackRelease(chords[chordIndex % chords.length], "1n", time);
                chordIndex++;
            }, "1n").start(0);

            Tone.Transport.bpm.value = 65; // Relaxed tempo
            Tone.Transport.start();
            isBGMPlaying = true;
            document.getElementById('bgm-toggle').textContent = 'â¸';
            document.getElementById('bgm-toggle').classList.add('text-emerald-400');
        }
        
        function stopBGM() {
            if (bgmLoop) {
                bgmLoop.stop();
                bgmLoop.dispose();
                bgmLoop = null;
            }
            Tone.Transport.stop();
            isBGMPlaying = false;
            document.getElementById('bgm-toggle').textContent = 'â™«';
            document.getElementById('bgm-toggle').classList.remove('text-emerald-400');
        }

        async function initializeAudio() {
            if (isAudioInitialized) return;
            try {
                await Tone.start();
                isAudioInitialized = true;
                startBGM();
            } catch (e) {
                console.error(e);
            }
        }
        
        // ----------------------------------------------------
        // 3. UI Helper & Error Handling (Updated)
        // ----------------------------------------------------

        function displayModal(title, content, actionButtons = '') {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-overlay" id="game-modal" onclick="if(event.target.id === 'game-modal') document.getElementById('modal-container').innerHTML = ''">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                            <h2 class="text-3xl font-bold text-white tracking-tight drop-shadow-md">${title}</h2>
                            <button class="bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white w-10 h-10 rounded-full flex items-center justify-center transition border border-white/5" onclick="document.getElementById('modal-container').innerHTML = ''">
                                âœ•
                            </button>
                        </div>
                        <div class="text-slate-300 leading-relaxed space-y-4 text-lg">
                            ${content}
                        </div>
                        ${actionButtons ? `<div class="mt-8 pt-6 border-t border-white/10 flex justify-end gap-3">${actionButtons}</div>` : `<div class="mt-8 pt-6 border-t border-white/10 flex justify-end"><button class="soft-btn-secondary btn-base px-8 py-3 text-lg shadow-lg" onclick="document.getElementById('modal-container').innerHTML = ''">é—œé–‰</button></div>`}
                    </div>
                </div>
            `;
        }
        
        // NEW: Function to display glossary definition
        window.showGlossaryDefinition = (term) => {
            playClickSFX();
            const definition = gameState.glossary[term];
            if (definition) {
                displayModal(`ğŸ“š è©å½™å®šç¾©: ${term}`, 
                    `<p class="text-2xl text-emerald-400 font-bold mb-4 drop-shadow-md">${term}</p>
                    <p class="text-white text-lg bg-black/30 p-4 rounded-xl border border-white/10">${parseText(definition)}</p>
                    <p class="text-xs text-slate-500 mt-4 italic">æ­¤è³‡æ–™æºæ–¼ AI è‡ªå‹•åˆ†æã€‚</p>`
                );
            } else {
                displayModal('éŒ¯èª¤', `<p>æ‰¾ä¸åˆ°å®šç¾©ã€‚</p>`);
            }
        };

        // UPDATED: Error Handling with specific Modal for Quota Limits
        function displayError(message) {
            toggleLoading(false); // Stop spinner
            playFailureSFX();

            // Default to Quota Limit message if error seems related to API failure/limits
            const criticalErrorContent = `
                <div class="text-center p-6">
                    <div class="text-6xl mb-6 filter drop-shadow-[0_0_15px_rgba(244,63,94,0.5)]">âš ï¸</div>
                    <p class="text-rose-400 text-2xl font-bold mb-2">ç³»çµ±é€£ç·šä¸­æ–·</p>
                    <p class="text-slate-400 mb-8 font-mono">éŒ¯èª¤ä»£ç¢¼: ${message}</p>
                    <div class="bg-rose-500/10 border border-rose-500/40 p-6 rounded-2xl mb-4 shadow-[0_0_20px_rgba(244,63,94,0.1)]">
                        <p class="text-rose-200 font-bold text-lg">æ‚¨çš„é‡‘é‘°å·²é”ä½¿ç”¨ä¸Šé™ï¼Œè«‹æ›ä¸€å€‹é‡‘é‘°ç¹¼çºŒéŠç©</p>
                    </div>
                </div>
            `;

            displayModal(
                'é€£ç·šéŒ¯èª¤',
                criticalErrorContent,
                `<button class="soft-btn-danger btn-base w-full py-4 text-xl shadow-xl hover:scale-[1.02]" onclick="resetGameSystem()">
                    ğŸ”„ é‡è¨­é‡‘é‘°ä¸¦é‡å•Ÿ
                </button>`
            );
        }
        
        // Function to reset game state and return to Stage 0
        window.resetGameSystem = function() {
            playClickSFX();
            apiKey = "";
            gameState.scenario = "";
            document.getElementById('modal-container').innerHTML = ''; // Close modal
            
            // Clean inputs
            const keyInput = document.getElementById('api-key-input-field');
            if (keyInput) keyInput.value = "";
            
            renderApiKeyInput(); // Re-render Stage 0 UI
            showStage(0); // Switch view
        };

        function hideError() {
            // Deprecated as we use modal now, but kept for safety
            if (errorState) errorState.classList.add('hidden');
        }

        function showScenario(show) {
            const container = document.getElementById('scenario-display-container');
            const content = document.getElementById('scenario-content-display');
            if (show && gameState.scenario) {
                const opContent = gameState.scenario;
                content.innerHTML = parseText(opContent);
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function showStage(stage) {
            const prev = stages[gameState.currentStage];
            if (prev) {
                prev.classList.add('hidden');
                prev.classList.remove('stage-transition');
            }

            const next = stages[stage];
            if (next) {
                next.classList.remove('hidden');
                setTimeout(() => next.classList.add('stage-transition'), 10);
            }

            gameState.currentStage = stage;
            const stageNames = {
                0: 'åˆå§‹åŒ–', 
                1: 'é‚è¼¯åˆ†æ', 
                2: 'çµæœå›é¡§',
                3: 'è§’è‰²æ¨¡æ“¬', 
                4: 'æƒ…å ±è’é›†', 
                5: 'é­”ç‹æˆ°', 
                6: 'æœ€çµ‚çµç®—'
            };
            if(stageDisplay) stageDisplay.textContent = `éšæ®µ: ${stageNames[stage]}`;

            showScenario(stage >= 1);
        }

        function toggleLoading(show, message = 'AI é‹ç®—ä¸­...') {
            if (loadingState) {
                if (show) {
                    loadingState.classList.remove('hidden');
                    loadingState.classList.add('flex');
                } else {
                    loadingState.classList.add('hidden');
                    loadingState.classList.remove('flex');
                }
                loadingMessage.textContent = message;
            }
        }
        
        // ----------------------------------------------------
        // 4. API & Schemas
        // ----------------------------------------------------
        
        function createPayload(prompt, schema, isRandomCall = false) {
            const systemPrompt = isRandomCall 
                ? "è«‹ç”Ÿæˆè²¼è¿‘ Threads/Dcard é¢¨æ ¼çš„ä¸­æ–‡è²¼æ–‡ã€‚è«‹è¼¸å‡ºç´”æ–‡å­—ï¼Œä¸è¦ä½¿ç”¨markdownæ ¼å¼ã€‚"
                : "æ‚¨æ˜¯æ€ç¶­è¾¯è«–éŠæˆ²AIã€‚è«‹åš´æ ¼æŒ‰ç…§JSON Schemaè¼¸å‡ºç¹é«”ä¸­æ–‡ã€‚è§’è‰²è³‡è¨Šéœ€åŒ…å«emojièˆ‡ç«‹å ´å‹•æ©Ÿã€‚ä¸è¦ä½¿ç”¨markdownæ ¼å¼ã€‚";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }
            return payload;
        }
        
        const randomScenarioSchema = { type: "OBJECT", properties: { "postTitle": { "type": "STRING" }, "postContent": { "type": "STRING" } }, required: ["postTitle", "postContent"] };
        const gameSetupSchema = { 
            type: "OBJECT", 
            properties: { 
                "fojStatements": { 
                    "type": "ARRAY", 
                    "items": { 
                        "type": "OBJECT", 
                        "properties": {
                            "statement": { "type": "STRING" },
                            "correctAnswer": { "type": "STRING", "enum": ["Fact", "Opinion"] },
                            "explanation": { "type": "STRING" },
                            "term": { "type": "STRING", "description": "If the statement contains a complex or ambiguous noun/term, list it here for glossary. Otherwise, leave it empty." },
                            "termDefinition": { "type": "STRING", "description": "The concise definition of the term, if provided." } 
                        },
                        "required": ["statement", "correctAnswer", "explanation", "term", "termDefinition"] 
                    } 
                }, 
                "characters": { 
                    "type": "ARRAY", 
                    "items": { 
                        "type": "OBJECT", 
                        "properties": { 
                            "name": { "type": "STRING" }, 
                            "job": { "type": "STRING" }, 
                            "icon": { "type": "STRING" }, 
                            "stance": { "type": "STRING" }, 
                            "motivation": { "type": "STRING" }, 
                            "comment": { "type": "STRING" } 
                        }, 
                        "required": ["name", "job", "icon", "stance", "motivation", "comment"] 
                    } 
                } 
            }, 
            required: ["fojStatements", "characters"] 
        };
        const rolePlayCritiqueSchema = { type: "OBJECT", properties: { "score": { "type": "NUMBER" }, "critique": { "type": "STRING" } }, required: ["score", "critique"] };
        const trollCharacterSchema = { type: "OBJECT", properties: { 
            "name": { "type": "STRING" }, 
            "job": { "type": "STRING", "description": "The troll's precise job or status, e.g., å¾…æ¥­ã€å¤§å­¸ç”Ÿã€ç‰©æµå¸æ©Ÿã€äººè³‡åŠ©ç†" }, 
            "age": { "type": "NUMBER", "description": "The troll's age, use a random number between 18 and 50." },
            "icon": { "type": "STRING" }, 
            "stance": { "type": "STRING" }, 
            "initialComment": { "type": "STRING" },
            "fallacies": { "type": "ARRAY", "items": { "type": "STRING", "description": "List 3 common logical fallacies the troll might use, e.g., ç¨»è‰äººè¬¬èª¤, äººèº«æ”»æ“Š, è¨´è«¸æƒ…æ„Ÿ" } } 
        }, required: ["name", "job", "age", "icon", "stance", "initialComment", "fallacies"] };
        const bossResponseSchema = { type: "OBJECT", properties: { "bossResponse": { "type": "STRING" }, "statusMessage": { "type": "STRING" }, "moraleChange": { "type": "NUMBER", "description": "Negative integer (e.g., -20) if player argument is good/logical. Positive (e.g., +10) if player is irrational or weak." }, "logicalFallacy": { "type": "STRING", "description": "The specific logical fallacy used in this bossResponse, e.g., è¨´è«¸ç¾¤çœ¾" } }, required: ["bossResponse", "statusMessage", "moraleChange", "logicalFallacy"] };
        const evaluationSchema = { type: "OBJECT", properties: { "persuasionSuccess": { "type": "BOOLEAN" }, "finalBossVerdict": { "type": "STRING" }, "logicScore": { "type": "NUMBER" }, "debateCritique": { "type": "STRING" }, "debateSuggestions": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["persuasionSuccess", "finalBossVerdict", "logicScore", "debateCritique", "debateSuggestions"] };
        const hintSchema = { type: "OBJECT", properties: { 
            "hintText": { "type": "STRING" },
            "keyTerm": { "type": "STRING", "description": "A single key technical or ambiguous term that the player should pay attention to." },
            "termDefinition": { "type": "STRING", "description": "A brief explanation of the key term to aid the player's understanding." }
        }, required: ["hintText", "keyTerm", "termDefinition"] };


        // ----------------------------------------------------
        // 5. API Fetch
        // ----------------------------------------------------
        async function fetchWithRetry(url, options, maxRetries = 5) { // å¢åŠ é‡è©¦æ¬¡æ•¸è‡³ 5
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    
                    // ç‰¹åˆ¥è™•ç† 429ï¼Œå…è¨±é‡è©¦
                    if (response.status === 429) {
                         throw new Error("429"); 
                    }
                    
                    if (response.status === 403 || response.status === 401) throw new Error("API Key Error");
                    throw new Error(`Error: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // æŒ‡æ•¸é€€é¿ç­–ç•¥ï¼š1s, 2s, 4s, 8s, 16s
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }
        }

        async function apiCall(payload) {
            if (!apiKey || apiKey.trim() === '') throw new Error("API Key Missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetchWithRetry(url, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) return JSON.parse(jsonText);
            throw new Error("No valid response from AI");
        }

        // ----------------------------------------------------
        // 6. Stage 0: Init
        // ----------------------------------------------------
        function renderApiKeyInput() {
            const html = `
                <div class="card p-10 arena-bg max-w-xl mx-auto text-center border-t-4 border-emerald-500 shadow-2xl">
                    <h2 class="text-4xl font-bold text-white mb-8 tracking-tight drop-shadow-md">
                        ç³»çµ±å•Ÿå‹• <span class="text-emerald-400 text-lg align-top ml-2">INITIALIZE</span>
                    </h2>
                    
                    <div class="mb-8 text-left bg-black/20 p-6 rounded-2xl border border-white/5 backdrop-blur-sm">
                        <h3 class="text-emerald-400 font-bold mb-3 text-sm tracking-wider uppercase flex items-center">
                            <span class="w-2 h-2 bg-emerald-400 rounded-full mr-2 animate-pulse"></span>
                            API Key å–å¾—æ–¹å¼
                        </h3>
                        <ol class="text-sm text-slate-300 space-y-2 list-decimal list-inside font-medium">
                            <li>å‰å¾€ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-white hover:text-emerald-400 underline transition-colors">Google AI Studio</a></li>
                            <li>é»æ“Š <strong>Create API key</strong></li>
                            <li>è¤‡è£½ä¸¦è²¼ä¸Šæ‚¨çš„å¯†é‘°</li>
                        </ol>
                    </div>

                    <div class="mb-8 relative group">
                        <div class="absolute inset-0 bg-emerald-500/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity rounded-xl"></div>
                        <input type="password" id="api-key-input-field" 
                            class="w-full p-5 text-center text-lg placeholder-slate-500 relative z-10"
                            placeholder="AIzaSy... [åœ¨æ­¤è²¼ä¸Š Key]">
                    </div>
                    
                    <button id="submit-api-key" class="w-full soft-btn btn-base py-5 text-xl tracking-wide shadow-emerald-500/30">
                        ç¢ºèªä¸¦é€£ç·š
                    </button>
                    <p class="text-xs text-slate-500 mt-6">æ‚¨çš„ Key åƒ…ç”¨æ–¼ç€è¦½å™¨ç«¯é€£ç·šï¼Œä¸æœƒè¢«å„²å­˜ã€‚</p>
                </div>
            `;
            stages[0].innerHTML = html;
            
            document.getElementById('submit-api-key').addEventListener('click', () => {
                const key = document.getElementById('api-key-input-field').value.trim();
                if (key.length > 20) { // Basic validation
                    apiKey = key;
                    playClickSFX();
                    playSuccessSFX();
                    renderTopicSelection(); // Proceed to next step
                } else {
                    displayError("ç„¡æ•ˆçš„ API Key æ ¼å¼");
                }
            });
        }

        // å®šç¾©å„åˆ†é¡çš„å°ˆå±¬ Prompt
        const TOPIC_PROMPTS = {
            "ä¸–ç•Œæ™‚äº‹": "è«‹æ‰®æ¼”ä¸€ä½éµç›¤åœ‹éš›é—œä¿‚å°ˆå®¶ï¼Œé‡å°ç•¶å‰åœ‹éš›åœ°ç·£æ”¿æ²»æˆ–å…¨çƒç¶“æ¿Ÿï¼Œç™¼è¡¨ä¸€ç¯‡çœ‹ä¼¼æœ‰ç†ä½†å……æ»¿åè¦‹çš„ã€é€†é¢¨ã€è²¼æ–‡ã€‚èªæ°£è¦å¸¶æœ‰ã€çœ¾äººçš†é†‰æˆ‘ç¨é†’ã€çš„å„ªè¶Šæ„Ÿï¼ŒæŒ‘æˆ°ä¸»æµåƒ¹å€¼è§€ã€‚å…§å®¹éœ€å…·å‚™é«˜åº¦çˆ­è­°æ€§ã€‚",
            "ç¤¾æœƒè­°é¡Œ": "è«‹æ¨¡ä»¿ Dcard ç†±é–€æ–‡ç« é¢¨æ ¼ï¼Œä»¥ç¬¬ä¸€äººç¨±åˆ†äº«ä¸€å€‹é—œæ–¼ã€ä¸–ä»£å°ç«‹ã€ã€ã€æ€§åˆ¥æˆ°çˆ­ã€æˆ–ã€è²§å¯Œå·®è·ã€çš„å€‹äººç¶“æ­·ï¼Œä¸¦å°‡å…¶éåº¦å¼•ç”³ç‚ºç¤¾æœƒçµæ§‹å•é¡Œã€‚èªæ°£è¦æ¿€å‹•ã€æƒ…ç·’åŒ–ï¼Œåˆ»æ„è£½é€ å°ç«‹ï¼Œå¸å¼•å…©æ´¾äººé¦¬æˆ°ç¿»ã€‚",
            "ç”Ÿæ´»æ™‚äº‹": "è«‹æ¨¡ä»¿ Threads çš„å»¢æ–‡é¢¨æ ¼ï¼Œé‡å°å°ç£äº¤é€šã€ç‰©åƒ¹æˆ–é£Ÿå®‰å•é¡Œï¼Œç™¼è¡¨ä¸€ç¯‡æ¥µåº¦å­ä¸–ä¸”å¸¶æœ‰æ”»æ“Šæ€§çš„æŠ±æ€¨æ–‡ã€‚å…§å®¹è¦å……æ»¿æƒ…ç·’æ€§å­—çœ¼ï¼Œä¸éœ€è¦å¤ªå¤šé‚è¼¯ï¼Œé‡é»æ˜¯å¼•èµ·å…±é³´è®“å¤§å®¶ä¸€èµ·ç½µã€‚",
            "ç§‘æŠ€è¶¨å‹¢": "è«‹æ‰®æ¼”ä¸€ä½æ¿€é€²çš„ç§‘æŠ€æ‡·ç–‘è«–è€…ï¼Œé‡å°ã€AI å–ä»£äººé¡ã€ã€ã€ç§‘æŠ€ç›£æ§ã€æˆ–ã€å¤§å…¬å¸å£Ÿæ–·ã€ç™¼è¡¨ä¸€ç¯‡å……æ»¿ç„¦æ…®èˆ‡é™°è¬€è«–çš„è²¼æ–‡ã€‚èªæ°£è¦ææ…Œï¼Œä¸¦æš—ç¤ºäººé¡æœ«æ—¥å³å°‡åˆ°ä¾†ã€‚",
            "å¨›æ¨‚å…«å¦": "è«‹æ¨¡ä»¿å£¹é€±åˆŠæˆ–å…«å¦ç‰ˆå£å»ï¼Œé‡å°ä¸€å€‹è™›æ§‹çš„ç•¶ç´…æ˜æ˜Ÿæˆ–ç¶²ç´…ç¿»è»Šäº‹ä»¶é€²è¡Œçˆ†æ–™èˆ‡å…¬å¯©ã€‚å…§å®¹è¦åŒ…å«ã€äººè¨­å´©å£ã€ã€ã€ç§å¾·æ•—å£ã€ç­‰å…ƒç´ ï¼Œèªæ°£è¦å°–é…¸åˆ»è–„ï¼Œç«™åœ¨é“å¾·åˆ¶é«˜é»æ‰¹åˆ¤ã€‚",
            "éš¨æ©Ÿç”Ÿæˆ": "è«‹éš¨æ©ŸæŒ‘é¸ä¸€å€‹ç›®å‰ç¶²è·¯æœ€ç†±é–€ä¸”æœ€å…·çˆ­è­°çš„è©±é¡Œï¼ˆå¦‚å…©æ€§ã€æ”¿æ²»ã€ç’°ä¿ï¼‰ï¼Œç”Ÿæˆä¸€ç¯‡å¼•æˆ°è²¼æ–‡ã€‚èªæ°£è¦æ¨¡ç¨œå…©å¯ï¼Œæˆ–æ˜¯æ•…æ„èªªå‡ºæ¥µç«¯çš„ã€æ”¿æ²»ä¸æ­£ç¢ºã€è¨€è«–ï¼Œç›®çš„æ˜¯è®“åº•ä¸‹ç•™è¨€å€åµæˆä¸€åœ˜ã€‚",
        };

        async function generateRandomScenario(category) {
            playClickSFX();
            toggleLoading(true, `AI æ­£åœ¨ç”Ÿæˆã€Œ${category}ã€ä¸»é¡Œ...`);
            try {
                // ä½¿ç”¨å°ˆå±¬çš„æç¤ºè©
                const specificPrompt = TOPIC_PROMPTS[category] || TOPIC_PROMPTS["éš¨æ©Ÿç”Ÿæˆ"];
                const prompt = `${specificPrompt} å…§å®¹éœ€å¸¶æœ‰æœ‰è¶£æˆ–åè«·çš„é¢¨æ ¼ã€‚150å­—å·¦å³ã€‚æä¾›æ¨™é¡Œå’Œå…§å®¹ã€‚è«‹è¼¸å‡ºç´”æ–‡å­—å…§å®¹ï¼Œçµ•å°ä¸è¦ä½¿ç”¨Markdownæ ¼å¼ï¼ˆå¦‚**ç²—é«”**ï¼‰ï¼Œè«‹çµ¦æˆ‘ä¹¾æ·¨çš„ç´”æ–‡æœ¬ã€‚`;
                
                const payload = createPayload(prompt, randomScenarioSchema, true);
                const aiResult = await apiCall(payload);
                
                // å†æ¬¡éæ¿¾ä»»ä½•æ®˜ç•™çš„ ** ç¬¦è™Ÿ
                const cleanTitle = aiResult.postTitle.replace(/\*\*/g, '');
                const cleanContent = aiResult.postContent.replace(/\*\*/g, '');
                
                gameState.scenario = `${cleanTitle}\n\n${cleanContent}`;
                gameState.scenarioCategory = category;
                
                document.getElementById('scenario-input').value = gameState.scenario;
                
                toggleLoading(false);
            } catch (error) {
                displayError(error.message);
            }
        }
        
        function renderTopicSelection() {
            const html = `
                <div class="card p-10 arena-bg">
                    <h2 class="text-4xl font-bold text-white mb-8 tracking-tight drop-shadow-md text-center md:text-left">
                        é¸æ“‡æˆ°å ´è©±é¡Œ
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-5 mb-10">
                        <button data-category="ä¸–ç•Œæ™‚äº‹" class="soft-btn-secondary btn-base py-6 text-lg hover:border-emerald-400 hover:text-emerald-300">ğŸŒ ä¸–ç•Œæ™‚äº‹</button>
                        <button data-category="ç¤¾æœƒè­°é¡Œ" class="soft-btn-secondary btn-base py-6 text-lg hover:border-pink-400 hover:text-pink-300">ğŸ—£ï¸ ç¤¾æœƒè­°é¡Œ</button>
                        <button data-category="ç”Ÿæ´»æ™‚äº‹" class="soft-btn-secondary btn-base py-6 text-lg hover:border-blue-400 hover:text-blue-300">ğŸ¡ ç”Ÿæ´»æ™‚äº‹</button>
                        <button data-category="ç§‘æŠ€è¶¨å‹¢" class="soft-btn-secondary btn-base py-6 text-lg hover:border-purple-400 hover:text-purple-300">ğŸ¤– ç§‘æŠ€è¶¨å‹¢</button>
                        <button data-category="å¨›æ¨‚å…«å¦" class="soft-btn-secondary btn-base py-6 text-lg hover:border-yellow-400 hover:text-yellow-300">ğŸ¿ å¨›æ¨‚å…«å¦</button>
                        <button data-category="éš¨æ©Ÿç”Ÿæˆ" class="soft-btn-secondary btn-base py-6 text-lg hover:border-white hover:text-white">ğŸ² éš¨æ©Ÿç”Ÿæˆ</button>
                    </div>

                    <div class="relative flex py-6 items-center">
                        <div class="flex-grow border-t border-white/10"></div>
                        <span class="flex-shrink-0 mx-6 text-slate-500 text-sm font-bold tracking-wider">æˆ–æ˜¯æ‰‹å‹•è¼¸å…¥è²¼æ–‡</span>
                        <div class="flex-grow border-t border-white/10"></div>
                    </div>

                    <div class="relative">
                        <textarea id="scenario-input" rows="4" 
                                class="w-full p-6 text-lg leading-relaxed shadow-inner"
                                placeholder="åœ¨æ­¤è²¼å…¥ Threads/Dcard æ–‡ç« å…§å®¹..."></textarea>
                        <div class="absolute bottom-4 right-4 text-slate-600 text-xs pointer-events-none">æ”¯æ´ä¸­æ–‡å…§å®¹</div>
                    </div>
                    
                    <button id="start-button" class="mt-8 w-full soft-btn btn-base py-5 text-xl tracking-widest shadow-emerald-500/20 hover:scale-[1.01]">
                        é–‹å§‹æŒ‘æˆ°
                    </button>
                </div>
            `;
            stages[0].innerHTML = html;

            stages[0].querySelectorAll('button[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    initializeAudio();
                    const cat = btn.getAttribute('data-category');
                    generateRandomScenario(cat);
                });
            });

            document.getElementById('start-button').addEventListener('click', async () => {
                playClickSFX();
                initializeAudio();
                const scenario = document.getElementById('scenario-input').value.trim();
                if (!scenario) return displayError("è«‹è¼¸å…¥è²¼æ–‡å…§å®¹");
                
                gameState.scenario = scenario;
                gameState.scenarioCategory = gameState.scenarioCategory || "è‡ªè¡Œè¼¸å…¥";

                toggleLoading(true, `AI æ­£åœ¨åˆ†æè²¼æ–‡æ¶æ§‹...`);
                try {
                    const prompt = `é‡å°è²¼æ–‡ï¼šã€Œ${gameState.scenario}ã€ã€‚ç”Ÿæˆ5å€‹é™³è¿°å¥ï¼Œä¸¦ç‚ºæ¯å€‹é™³è¿°å¥æä¾›å…¶æ­£ç¢ºçš„ F/O (äº‹å¯¦/è§€é») åˆ†é¡ã€è©³ç´°è§£é‡‹ï¼Œä»¥åŠå¦‚æœåŒ…å«è¤‡é›œè©å½™ï¼Œè«‹åœ¨ "term" æ¬„ä½æä¾›è©²è©å½™ä¸¦åœ¨ "termDefinition" æ¬„ä½æä¾›è©²è©å½™çš„ç°¡æ½”è§£é‡‹ã€‚è«‹**ä¸è¦**ä½¿ç”¨ã€Œåˆ¤æ–·(Judgment)ã€ä½œç‚ºåˆ†é¡çµæœã€‚åŒæ™‚ç”Ÿæˆ3å€‹ä¸åŒç«‹å ´çš„ç¤¾ç¾¤è§’è‰²ï¼Œæ¯å€‹è§’è‰²éœ€æœ‰åå­—ã€è·æ¥­ã€emoji iconã€ç«‹å ´ã€å…·é«”å‹•æ©Ÿ(motivation)èˆ‡åˆå§‹è©•è«–ã€‚ç¹é«”ä¸­æ–‡ã€‚`;
                    const payload = createPayload(prompt, gameSetupSchema);
                    gameState.gameData = await apiCall(payload); 
                    gameState.fojScore = 0; 
                    
                    gameState.glossary = {};
                    gameState.gameData.fojStatements.forEach(item => {
                        if (item.term && item.termDefinition) {
                            gameState.glossary[item.term] = item.termDefinition;
                        }
                    });

                    toggleLoading(false);
                    playSuccessSFX();
                    renderStage1();
                    showStage(1);
                } catch (error) {
                    displayError(error.message);
                }
            });
        }
        
        // ----------------------------------------------------
        // 7. Stage 1: F/O (Logic and Gameification)
        // ----------------------------------------------------
        function renderStage1() {
            const fojData = gameState.gameData.fojStatements;
            let html = `
                <div class="card p-8 mb-8 border-l-4 border-emerald-500 fade-in-up bg-slate-900/40">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-3xl font-bold text-emerald-400 drop-shadow-md">Phase 1: é‚è¼¯æ‹†è§£</h2>
                        <div class="flex items-center gap-4 bg-black/20 px-4 py-2 rounded-full border border-white/5">
                            <span class="text-xs font-bold text-slate-400 tracking-wider">SCORE</span>
                            <span id="foj-current-score" class="text-3xl font-black text-amber-400 drop-shadow-[0_0_10px_rgba(251,191,36,0.3)]">${gameState.fojScore}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 text-slate-400 text-sm font-medium">
                        <span>è«‹åˆ¤æ–·ä»¥ä¸‹é™³è¿°æ˜¯</span>
                        <strong class="text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded">äº‹å¯¦ (Fact)</strong>
                        <span>é‚„æ˜¯</span>
                        <strong class="text-amber-400 bg-amber-500/10 px-2 py-0.5 rounded">è§€é» (Opinion)</strong>
                        <button id="foj-info-button" class="ml-auto text-xs bg-white/5 border border-white/10 px-3 py-1.5 rounded-full text-slate-300 hover:text-white hover:bg-white/10 transition">è¦å‰‡èªªæ˜</button>
                    </div>
                </div>
                <div id="statement-list" class="space-y-5 fade-in-up" style="animation-delay: 0.1s">
            `;
            
            fojData.forEach((item, idx) => { 
                html += `
                    <div class="card p-6 flex flex-col md:flex-row justify-between items-center gap-6 foj-statement relative hover:border-emerald-500/30 transition-all group" data-index="${idx}" data-state="pending">
                        <p class="text-slate-100 flex-grow font-medium leading-relaxed text-lg group-hover:text-white transition-colors">
                            <span class="text-emerald-500/50 font-bold mr-4 text-2xl align-middle">0${idx+1}</span>${parseText(item.statement)}
                        </p>
                        <div class="flex gap-3 shrink-0 foj-buttons">
                            <button data-type="Fact" class="btn-base bg-slate-800/50 border border-emerald-500/30 text-emerald-400 hover:bg-emerald-500 hover:text-white py-3 px-8 text-base font-bold shadow-lg">äº‹å¯¦</button>
                            <button data-type="Opinion" class="btn-base bg-slate-800/50 border border-amber-500/30 text-amber-400 hover:bg-amber-500 hover:text-white py-3 px-8 text-base font-bold shadow-lg">è§€é»</button>
                        </div>
                        <div class="result-message hidden absolute right-6 top-6 px-3 py-1 rounded-lg bg-black/60 backdrop-blur-sm border border-white/10 font-bold text-sm shadow-xl"></div>
                    </div>
                `;
            });

            html += `</div>
                <button id="stage1-next-button" class="mt-10 w-full soft-btn-secondary btn-base py-5 text-xl shadow-lg hover:shadow-indigo-500/20" disabled>
                    æäº¤ä¸¦æª¢è¦–çµæœ
                </button>
            `;
            stages[1].innerHTML = html;
            
            const userSelections = new Array(fojData.length).fill(null);
            const nextBtn = document.getElementById('stage1-next-button');
            const scoreDisplay = document.getElementById('foj-current-score');
            let completedCount = 0;

            document.getElementById('foj-info-button').addEventListener('click', () => {
                displayModal('F/O å®šç¾©', 
                    `<div class="grid gap-4">
                        <div class="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl">
                            <strong class="text-emerald-400 text-lg block mb-1">äº‹å¯¦ (Fact)</strong>
                            <p class="text-slate-300">å®¢è§€å­˜åœ¨ï¼Œå¯è¢«é©—è­‰çœŸå½çš„æè¿°ã€‚<br><span class="text-xs opacity-70">ä¾‹å¦‚ï¼šã€Œæ°´åœ¨100åº¦æ²¸é¨°ã€‚ã€</span></p>
                        </div>
                        <div class="p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl">
                            <strong class="text-amber-400 text-lg block mb-1">è§€é» (Opinion)</strong>
                            <p class="text-slate-300">å€‹äººçš„æƒ³æ³•ã€æ„Ÿå—æˆ–åƒ¹å€¼åˆ¤æ–·ï¼Œç„¡çµ•å°å°éŒ¯ã€‚<br><span class="text-xs opacity-70">ä¾‹å¦‚ï¼šã€Œé€™æ¯æ°´å¤ªç‡™äº†ã€‚ã€</span></p>
                        </div>
                    </div>`);
            });

            document.querySelectorAll('.btn-base[data-type]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const parent = e.target.closest('.foj-statement');
                    if (parent.getAttribute('data-state') !== 'pending') return;
                    
                    playClickSFX();
                    const idx = parent.getAttribute('data-index');
                    const selectedType = e.target.getAttribute('data-type');
                    const correctType = fojData[idx].correctAnswer;
                    
                    userSelections[idx] = selectedType;
                    parent.setAttribute('data-state', 'selected');

                    parent.querySelectorAll('.btn-base').forEach(b => {
                        b.disabled = true;
                        b.classList.add('opacity-50', 'grayscale');
                    });
                    
                    // Highlight selected button logic
                    e.target.classList.remove('opacity-50', 'grayscale', 'bg-slate-800/50');
                    e.target.classList.add('ring-2', 'ring-white/50', 'scale-105');
                    
                    const messageEl = parent.querySelector('.result-message');
                    messageEl.classList.remove('hidden');

                    if (selectedType === correctType) {
                        playSuccessSFX();
                        parent.classList.add('border-emerald-500', 'bg-emerald-500/5');
                        messageEl.classList.add('text-emerald-400', 'border-emerald-500/30');
                        messageEl.innerHTML = 'âœ… <span class="ml-1">æ­£ç¢º</span>';
                        gameState.fojScore += 20; 
                    } else {
                        playFailureSFX();
                        parent.classList.add('border-rose-500', 'bg-rose-500/5');
                        messageEl.classList.add('text-rose-400', 'border-rose-500/30');
                        messageEl.innerHTML = `âŒ <span class="ml-1">éŒ¯èª¤</span> <span class="text-xs opacity-75 ml-1">(æ­£è§£: ${correctType})</span>`;
                    }

                    scoreDisplay.textContent = gameState.fojScore;

                    // Re-style the correct button to show it clearly
                    parent.querySelectorAll('.btn-base').forEach(b => {
                        if (b.getAttribute('data-type') === correctType) {
                            b.classList.remove('grayscale', 'opacity-50', 'bg-slate-800/50');
                            b.classList.add('bg-slate-700', 'text-white', 'border-white/20'); 
                        }
                    });

                    completedCount++;
                    if (completedCount === fojData.length) {
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('soft-btn-secondary');
                        nextBtn.classList.add('soft-btn');
                        nextBtn.innerHTML = 'æŸ¥çœ‹è©³ç´°è§£æ ğŸ‘‰';
                    }
                });
            });

            nextBtn.addEventListener('click', async () => {
                playClickSFX();
                gameState.userFactChecks = userSelections;
                
                renderStage2();
                showStage(2);
            });
        }

        // ----------------------------------------------------
        // 8. Stage 2: Result Review (Only Result, No Role Play)
        // ----------------------------------------------------
        function renderStage2() {
            const fojData = gameState.gameData.fojStatements;
            const statements = fojData.map(item => item.statement);
            
            let html = `
                <div class="card p-8 mb-8 border-l-4 border-emerald-500 fade-in-up bg-slate-900/40">
                    <h2 class="text-3xl font-bold text-emerald-400 mb-2 drop-shadow-md">Phase 2: åˆ†æçµæœå›é¡§</h2>
                    <div class="flex items-center gap-4">
                         <p class="text-slate-400 text-sm font-bold tracking-wider">LOGIC SCORE</p>
                         <span class="text-4xl font-black text-amber-400 drop-shadow-[0_0_15px_rgba(251,191,36,0.3)]">${gameState.fojScore} <span class="text-lg text-slate-500 font-normal">/ 100</span></span>
                    </div>
                </div>
                <div class="space-y-5 mb-10 fade-in-up" style="animation-delay: 0.1s">
            `;
            
            statements.forEach((stmt, i) => {
                const correct = fojData[i].correctAnswer;
                const explanation = fojData[i].explanation;
                const isCorrect = gameState.userFactChecks[i] === correct;
                const color = isCorrect ? 'border-emerald-500' : 'border-rose-500';
                const icon = isCorrect ? 'âœ…' : 'âŒ';
                
                const wrongBadge = !isCorrect ? `<span class="inline-block px-2 py-0.5 rounded bg-rose-500/20 text-rose-300 text-xs font-bold mr-2 mb-2 border border-rose-500/20">æ‚¨é¸: ${gameState.userFactChecks[i]}</span>` : '';

                html += `
                    <div class="card p-6 border-l-4 ${color} hover:translate-x-1 transition-transform">
                        <div class="flex justify-between items-start mb-3">
                            <p class="text-lg text-slate-200 font-medium leading-relaxed">${parseText(stmt)}</p>
                            <span class="text-xl ml-4 shrink-0 filter drop-shadow-lg">${icon}</span>
                        </div>
                        <div class="bg-black/30 p-4 rounded-xl border border-white/5 relative">
                            <div class="absolute top-0 left-0 w-1 h-full ${isCorrect ? 'bg-emerald-500/50' : 'bg-rose-500/50'} rounded-l-xl"></div>
                            <div class="pl-3">
                                ${wrongBadge} <span class="text-emerald-400 font-bold text-sm uppercase tracking-wide">æ­£è§£: ${correct}</span>
                                <p class="text-slate-400 text-sm mt-2 leading-relaxed">${parseText(explanation)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <button id="to-roleplay-btn" class="w-full soft-btn btn-base py-5 text-xl shadow-lg hover:shadow-emerald-500/20 fade-in-up" style="animation-delay: 0.2s">
                    é€²å…¥è§’è‰²æ¨¡æ“¬ (Role Play)
                </button>
            `;
            stages[2].innerHTML = html;

            document.getElementById('to-roleplay-btn').addEventListener('click', () => {
                playClickSFX();
                renderStage3();
                showStage(3);
            });
        }

        // ----------------------------------------------------
        // 9. Stage 3: Role Play (New Independent Stage)
        // ----------------------------------------------------
        function renderStage3() {
            if (gameState.assignedRoleIndex === null) {
                gameState.assignedRoleIndex = Math.floor(Math.random()*3);
            }
            const role = gameState.gameData.characters[gameState.assignedRoleIndex];

            let html = `
                <div class="card p-8 mb-8 border-l-4 border-indigo-500 fade-in-up bg-slate-900/40">
                    <h2 class="text-3xl font-bold text-indigo-400 mb-2 drop-shadow-md">Phase 3: è§’è‰²æ¨¡æ“¬</h2>
                    <p class="text-slate-400 text-sm font-medium">æ›ä½æ€è€ƒè¨“ç·´ã€‚è«‹æš«æ™‚æ”¾ä¸‹å€‹äººè§€é»ï¼Œå…¨å¿ƒæ‰®æ¼”ä»¥ä¸‹è§’è‰²ã€‚</p>
                </div>

                <div id="role-play-area" class="card p-10 border border-indigo-500/30 relative overflow-hidden fade-in-up group" style="animation-delay: 0.1s">
                    <!-- èƒŒæ™¯è£é£¾ -->
                    <div class="absolute -right-10 -top-10 text-[10rem] opacity-5 group-hover:opacity-10 transition-opacity select-none">ğŸ­</div>
                    <div class="absolute inset-0 bg-indigo-500/5 pointer-events-none"></div>
                    
                    <h2 class="text-2xl font-bold text-white mb-8 relative z-10 flex items-center">
                        <span class="w-2 h-8 bg-indigo-500 rounded-full mr-3 shadow-[0_0_10px_#6366f1]"></span>
                        è§’è‰²åˆ†æ´¾ (Role Assignment)
                    </h2>
                    
                    <div class="bg-slate-800/60 p-6 rounded-2xl border border-indigo-500/20 flex flex-col md:flex-row items-center gap-8 mb-8 relative z-10 backdrop-blur-sm">
                        <div class="text-8xl emoji-icon drop-shadow-2xl scale-110">${role.icon}</div>
                        <div class="flex-grow text-center md:text-left">
                            <h3 class="text-3xl font-black text-white mb-2 tracking-tight">${role.name}</h3>
                            <p class="text-indigo-300 font-bold mb-4 text-lg bg-indigo-500/10 inline-block px-3 py-1 rounded-lg border border-indigo-500/20">${role.job} <span class="mx-2 text-slate-500">|</span> ç«‹å ´ï¼š${role.stance}</p>
                            
                            <div class="bg-black/30 p-5 rounded-xl border-l-4 border-indigo-400 text-left shadow-inner">
                                <p class="text-xs text-indigo-300 font-bold mb-2 uppercase tracking-wider flex items-center">
                                    <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full mr-2"></span>æ ¸å¿ƒå‹•æ©Ÿ
                                </p>
                                <p class="text-slate-200 text-base italic leading-relaxed">"${parseText(role.motivation || 'ç„¡å‹•æ©Ÿè³‡æ–™')}"</p>
                            </div>
                        </div>
                    </div>

                    <div class="relative z-10">
                        <p class="text-slate-300 mb-3 font-bold flex items-center">
                            <span class="text-xl mr-2">âœï¸</span> ä»»å‹™ï¼šè«‹æ ¹æ“šè©²è§’è‰²çš„å‹•æ©Ÿèˆ‡ç«‹å ´ï¼Œæ’°å¯«ä¸€å‰‡ç•™è¨€ã€‚
                        </p>
                        <textarea id="role-input" rows="5" class="w-full p-5 text-lg shadow-inner" placeholder="è©¦è‘—æ¨¡ä»¿ ${role.name} çš„èªæ°£..."></textarea>
                        <button id="stage3-btn" class="mt-8 w-full soft-btn-secondary btn-base py-5 text-xl font-bold shadow-lg" disabled>
                            æäº¤æ¨¡æ“¬ç•™è¨€
                        </button>
                    </div>
                </div>
                <div id="critique-area"></div>
            `;
            stages[3].innerHTML = html;

            const input = document.getElementById('role-input');
            const btn = document.getElementById('stage3-btn');
            
            input.addEventListener('input', () => btn.disabled = input.value.length < 5);

            btn.addEventListener('click', async () => {
                playClickSFX();
                gameState.userRoleArgument = input.value;
                toggleLoading(true, 'AI å°å¸«æ­£åœ¨è©•åˆ†æ‚¨çš„æ¨¡ä»¿èƒ½åŠ›...');
                try {
                    const critiquePrompt = `è©•ä¼°è§’è‰²æ‰®æ¼”ï¼šè§’è‰² ${role.name} (è·æ¥­: ${role.job}, å‹•æ©Ÿ: ${role.motivation}, ç«‹å ´: ${role.stance})ï¼Œç©å®¶æ¨¡æ“¬è©•è«–ï¼š${input.value}ã€‚
æ‚¨ç¾åœ¨æ˜¯ä¸€å€‹æ¥µå…¶åš´æ ¼çš„è¾¯è«–å°å¸«ã€‚è«‹æ ¹æ“šç©å®¶å°è§’è‰²ç«‹å ´ã€èªæ°£å’Œæ ¸å¿ƒå‹•æ©Ÿçš„è²¼åˆç¨‹åº¦ï¼Œé€²è¡Œåš´å²çš„è©•åˆ†(0-100)ã€‚
è¦å‰‡ 1ï¼šè‹¥ç©å®¶çš„è©•è«–èˆ‡è§’è‰²è¨­å®šæœ‰ç´°å¾®åå·®ï¼Œè«‹åš´æ ¼æ‰£åˆ†ï¼ˆä¾‹å¦‚ï¼Œå‹•æ©Ÿæœªé«”ç¾ã€èªæ°£ä¸å¤ åƒã€è«–é»å¤ªç†æ€§ç­‰ï¼‰ã€‚
è¦å‰‡ 2 (è‡´å‘½éŒ¯èª¤)ï¼šå¦‚æœç©å®¶çš„è©•è«–åªæ˜¯ç›´æ¥è¤‡è£½æˆ–ç¨å¾®æ”¹å¯«ä¸Šè¿°æä¾›çš„ã€Œå‹•æ©Ÿã€æˆ–ã€Œç«‹å ´ã€æ–‡å­—ï¼Œè€Œä¸æ˜¯ä»¥è§’è‰²å£å»é€²è¡Œå‰µä½œï¼Œè«‹ç›´æ¥çµ¦äºˆ 0 åˆ†ï¼Œä¸¦åš´å²æ–¥è²¬é€™ç¨®å·æ‡¶è¡Œç‚ºã€‚
å‹™å¿…åœ¨è©•è«–(critique)ä¸­æ˜ç¢ºæŒ‡å‡ºç©å®¶æ¨¡ä»¿çš„æˆåŠŸèˆ‡å¤±æ•—ä¹‹è™•ã€‚
è«‹çµ¦åˆ†(0-100)èˆ‡å›é¥‹ã€‚`;
                    const res = await apiCall(createPayload(critiquePrompt, rolePlayCritiqueSchema));
                    gameState.rolePlayCritique = res;
                    
                    const scoreColor = res.score >= 80 ? 'text-emerald-400 drop-shadow-[0_0_10px_rgba(52,211,153,0.5)]' : (res.score >= 60 ? 'text-amber-400' : 'text-rose-400');
                    document.getElementById('role-play-area').classList.add('hidden');
                    document.getElementById('critique-area').innerHTML = `
                        <div class="card p-10 border-t-4 border-indigo-500 stage-transition text-center">
                            <div class="mb-8">
                                <h3 class="text-2xl font-bold text-slate-400 mb-2 uppercase tracking-widest">å°å¸«å›é¥‹</h3>
                                <div class="inline-block relative">
                                    <span class="text-8xl font-black ${scoreColor}">${res.score}</span>
                                    <span class="text-xl text-slate-500 absolute -right-8 top-2 font-bold">PTS</span>
                                </div>
                            </div>
                            <div class="bg-slate-800/60 p-8 mb-8 border border-white/10 rounded-2xl text-left shadow-lg">
                                <p class="text-slate-200 text-lg leading-relaxed">${parseText(res.critique)}</p>
                            </div>
                            <button id="to-stage4" class="w-full soft-btn btn-base py-5 text-xl shadow-lg hover:shadow-indigo-500/20">å‰å¾€ä¸‹ä¸€éšæ®µ</button>
                        </div>
                    `;
                    document.getElementById('to-stage4').addEventListener('click', () => {
                        renderStage4(); showStage(4);
                    });
                    toggleLoading(false);
                    playSuccessSFX();
                } catch (e) {
                    displayError(e.message);
                }
            });
        }

        // ----------------------------------------------------
        // 10. Stage 4: Observation (Renamed from Stage 3)
        // ----------------------------------------------------
        function renderStage4() {
            const characters = gameState.gameData.characters;
            const glossaryTerms = Object.keys(gameState.glossary);

            let html = `
                <div class="card p-8 mb-8 border-l-4 border-emerald-500 fade-in-up bg-slate-900/40">
                    <h2 class="text-3xl font-bold text-emerald-400 mb-2 drop-shadow-md">Phase 4: è¼¿è«–è§€å¯Ÿ</h2>
                    <p class="text-slate-400 text-sm font-medium">çŸ¥å·±çŸ¥å½¼ã€‚è§€å¯Ÿç¤¾ç¾¤ä¸Šä¸åŒç«‹å ´çš„è²éŸ³ä¸¦ç†Ÿæ‚‰è¡“èªã€‚</p>
                </div>

                <!-- Glossary Section -->
                ${glossaryTerms.length > 0 ? `
                <div class="card p-6 mb-8 bg-amber-500/5 border border-amber-500/20 fade-in-up" style="animation-delay: 0.1s">
                    <h3 class="text-lg font-bold text-amber-400 mb-4 flex items-center">
                        <span class="mr-2 text-xl">ğŸ“š</span> é—œéµè¡“èª (Keywords)
                    </h3>
                    <div id="glossary-list-stage3" class="flex flex-wrap gap-3">
                        ${glossaryTerms.map(term => `<span class="glossary-term" onclick="showGlossaryDefinition('${term.replace(/'/g, "\\'")}')">${term}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in-up" style="animation-delay: 0.2s">
            `;
            characters.forEach((char, i) => { 
                html += `
                    <div class="card p-6 hover:-translate-y-2 transition-transform duration-300 border-t border-white/5">
                        <div class="flex items-center mb-5">
                            <span class="text-5xl mr-4 emoji-icon drop-shadow-lg">${char.icon}</span>
                            <div>
                                <h3 class="font-bold text-white text-lg leading-tight mb-1">${char.name}</h3>
                                <p class="text-xs font-bold text-emerald-400 uppercase tracking-wide bg-emerald-500/10 px-2 py-0.5 rounded border border-emerald-500/20 inline-block">${char.job}</p>
                            </div>
                        </div>
                        <div class="dialog-bubble p-5 text-sm text-slate-200 leading-relaxed relative">
                            <div class="absolute -top-2 left-6 w-4 h-4 bg-slate-700/80 rotate-45 border-t border-l border-white/5"></div>
                            ${parseText(char.comment)}
                        </div>
                    </div>
                `;
            });
            html += `</div>
                <button id="to-stage5-setup" class="mt-12 w-full soft-btn-danger btn-base py-5 text-xl tracking-widest shadow-xl fade-in-up hover:scale-[1.01]" style="animation-delay: 0.3s">
                    âš ï¸ é€²å…¥æˆ°é¬¥æº–å‚™ (BATTLE SETUP)
                </button>
            `;
            stages[4].innerHTML = html;
            document.getElementById('to-stage5-setup').addEventListener('click', () => {
                playClickSFX();
                renderStage5Setup();
                showStage(5);
            });
        }

        // ----------------------------------------------------
        // 11. Stage 5: Boss Battle (Setup & Battle)
        // ----------------------------------------------------
        async function getHint(bossTxt, userTxt, bossFallacies) {
            const prompt = `
                æƒ…å¢ƒï¼š${gameState.scenario}
                é…¸æ°‘è«–é»ï¼š${bossTxt}
                é…¸æ°‘å¯èƒ½çš„é‚è¼¯è¬¬èª¤æ¸…å–®: ${bossFallacies.join(', ')}
                ç©å®¶å›°å¢ƒï¼šä¸çŸ¥é“å¦‚ä½•åé§ã€‚
                è«‹çµ¦å‡ºä¸€å€‹ç°¡çŸ­çš„ã€Œé‚è¼¯åé§æç¤ºã€ï¼ˆä¸è¦ç›´æ¥çµ¦ç­”æ¡ˆï¼ŒæŒ‡å‡ºå°æ–¹é‚è¼¯è¬¬èª¤æ–¹å‘æˆ–å¯ç”¨çš„äº‹å¯¦ï¼‰ã€‚åŒæ™‚ï¼Œå¦‚æœæç¤ºä¸­åŒ…å«é—œéµè¡“èªæˆ–æ¦‚å¿µï¼Œè«‹åœ¨ keyTerm å’Œ termDefinition ä¸­è¿”å›å…¶åç¨±å’Œè§£é‡‹ã€‚
            `;
            const payload = createPayload(prompt, hintSchema);
            return await apiCall(payload);
        }

        async function renderStage5Setup() {
            toggleLoading(true, 'æ­£åœ¨åµæ¸¬é…¸æ°‘æˆ°åŠ›...');
            gameState.debateHistory = [];
            gameState.bossMorale = 100;
            gameState.isSurrender = false;
            gameState.difficulty = 'MEDIUM'; // Reset to default

            try {
                const op = gameState.scenario.split('\n\n')[1] || gameState.scenario;
                const prompt = `é‡å°ã€Œ${op}ã€ç”Ÿæˆä¸€å€‹ã€Œæ²’çœ‹å…§æ–‡å°±é–‹å™´ã€çš„é…¸æ°‘ã€‚è«‹ç‚ºä»–æŒ‡å®šä¸€å€‹ç¢ºåˆ‡çš„è·æ¥­ï¼ˆä¾‹å¦‚ï¼šå¾…æ¥­ã€å¤§å­¸ç”Ÿã€ç‰©æµå¸æ©Ÿã€äººè³‡åŠ©ç†ç­‰ï¼‰å’Œå¹´é½¡ï¼ˆ18-50æ­²ï¼‰ã€‚ä¸¦æä¾›3ç¨®ä»–å¸¸ç”¨çš„é‚è¼¯è¬¬èª¤æ¸…å–®ã€‚ç¹é«”ä¸­æ–‡ã€‚`;
                const boss = await apiCall(createPayload(prompt, trollCharacterSchema));
                gameState.bossCharacter = boss;

                // Render Setup UI
                let html = `
                    <div class="card p-10 border-2 border-rose-500 text-center fade-in-up bg-slate-900/60 shadow-[0_0_30px_rgba(244,63,94,0.15)]">
                        <div class="inline-block mb-4 px-4 py-1 rounded-full bg-rose-500/20 text-rose-400 font-bold text-sm tracking-[0.2em] border border-rose-500/30 animate-pulse">WARNING</div>
                        <h2 class="text-4xl font-black text-white mb-8 tracking-tight drop-shadow-[0_0_10px_rgba(244,63,94,0.5)]">BOSS DETECTED</h2>
                        
                        <div class="flex justify-center mb-8 relative">
                            <div class="absolute inset-0 bg-rose-500/20 blur-3xl rounded-full scale-150"></div>
                            <div class="text-9xl emoji-icon animate-bounce z-10 drop-shadow-2xl grayscale-[0.2] contrast-125">${boss.icon}</div>
                        </div>
                        
                        <h3 class="text-3xl font-bold text-white mb-2">${boss.name}</h3>
                        <p class="text-rose-400 font-bold mb-8 text-lg">${boss.job} (${boss.age}æ­²) <span class="mx-2 text-slate-600">|</span> ${boss.stance}</p>
                        
                        <div class="bg-rose-900/10 p-8 border border-rose-500/30 rounded-2xl mb-10 text-left relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-rose-500"></div>
                            <p class="text-xs text-rose-400 font-bold mb-3 uppercase tracking-wider">æ”»æ“Šé å‘Š:</p>
                            <p class="text-white text-xl italic font-serif leading-relaxed">"${parseText(boss.initialComment)}"<br/></p>
                            <div class="mt-6 pt-4 border-t border-rose-500/20 flex flex-wrap gap-2">
                                <span class="text-xs text-rose-300 uppercase font-bold mr-2 mt-1">åµæ¸¬è¬¬èª¤:</span>
                                ${boss.fallacies.map(f => `<span class="bg-rose-500/20 text-rose-200 px-2 py-1 rounded text-xs border border-rose-500/30">${f}</span>`).join('')}
                            </div>
                        </div>

                        <h4 class="text-xl font-bold text-slate-300 mb-6 flex items-center justify-center"><span class="w-8 h-[1px] bg-slate-600 mr-4"></span>é¸æ“‡å°æˆ°é›£åº¦<span class="w-8 h-[1px] bg-slate-600 ml-4"></span></h4>
                        <div class="grid grid-cols-3 gap-4 mb-8" id="difficulty-selector">
                            <!-- Easy -->
                            <button data-difficulty="EASY" class="soft-btn-difficulty py-6 transition-all group hover:-translate-y-1">
                                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${DIFFICULTY_SETTINGS.EASY.icon}</div>
                                <h5 class="text-lg font-bold text-emerald-400 group-hover:text-emerald-300">ç°¡å–®</h5>
                                <p class="text-xs text-slate-500 group-hover:text-slate-400">å£æ¢å·®/æ˜“ç ´é˜²</p>
                            </button>
                            <!-- Medium -->
                            <button data-difficulty="MEDIUM" class="soft-btn-difficulty py-6 transition-all selected group hover:-translate-y-1">
                                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${DIFFICULTY_SETTINGS.MEDIUM.icon}</div>
                                <h5 class="text-lg font-bold text-indigo-400 group-hover:text-indigo-300">æ™®é€š</h5>
                                <p class="text-xs text-slate-500 group-hover:text-slate-400">æ­£å¸¸çˆ­è«–</p>
                            </button>
                            <!-- Hard -->
                            <button data-difficulty="HARD" class="soft-btn-difficulty py-6 transition-all group hover:-translate-y-1">
                                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${DIFFICULTY_SETTINGS.HARD.icon}</div>
                                <h5 class="text-lg font-bold text-rose-400 group-hover:text-rose-300">å›°é›£</h5>
                                <p class="text-xs text-slate-500 group-hover:text-slate-400">ä¸€èˆ¬è¾¯è«–ç­‰ç´š</p>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                            <button id="mode-rounds" data-mode="rounds" class="group relative bg-slate-800/60 hover:bg-emerald-500/10 border border-slate-600 hover:border-emerald-500/50 p-6 rounded-2xl transition-all ring-2 ring-emerald-500/50 shadow-lg">
                                <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">â±ï¸</div>
                                <h4 class="text-xl font-bold text-white mb-2">æˆ°è¡“å›åˆ</h4>
                                <div class="flex items-center justify-center space-x-3 bg-black/30 p-2 rounded-lg">
                                    <span class="text-sm text-slate-400 font-bold">å›åˆæ•¸:</span>
                                    <input type="number" id="round-input" value="4" min="1" max="10" class="w-12 bg-transparent text-center text-white font-bold border-b border-slate-500 focus:border-emerald-500 outline-none" onclick="event.stopPropagation()">
                                </div>
                                <div id="check-rounds" class="absolute top-4 right-4 text-emerald-400 text-xl bg-emerald-500/20 rounded-full w-6 h-6 flex items-center justify-center">âœ”</div>
                            </button>
                            <button id="mode-endless" data-mode="endless" class="group relative bg-slate-800/60 hover:bg-rose-500/10 border border-slate-600 hover:border-rose-500/50 p-6 rounded-2xl transition-all shadow-lg">
                                <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">ğŸ’€</div>
                                <h4 class="text-xl font-bold text-white mb-2">ç„¡ç›¡æ­»é¬¥</h4>
                                <p class="text-sm text-slate-400">ç›´åˆ°å£«æ°£æ­¸é›¶</p>
                                <div id="check-endless" class="absolute top-4 right-4 text-emerald-400 hidden text-xl bg-emerald-500/20 rounded-full w-6 h-6 flex items-center justify-center">âœ”</div>
                            </button>
                        </div>

                        <button id="start-battle" class="w-full soft-btn-danger btn-base py-5 text-2xl font-black tracking-widest shadow-xl hover:scale-[1.02] relative overflow-hidden group">
                            <span class="relative z-10">é–‹æˆ°! FIGHT</span>
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                        </button>
                    </div>
                `;
                stages[5].innerHTML = html;
                toggleLoading(false);

                // --- Mode Selection Logic ---
                let selectedMode = 'rounds';
                const btnEndless = document.getElementById('mode-endless');
                const btnRounds = document.getElementById('mode-rounds');
                const checkEndless = document.getElementById('check-endless');
                const checkRounds = document.getElementById('check-rounds');
                const roundInput = document.getElementById('round-input');

                function selectMode(mode) {
                    selectedMode = mode;
                    if (mode === 'endless') {
                        btnEndless.classList.add('ring-2', 'ring-rose-500/50', 'bg-rose-500/10');
                        btnRounds.classList.remove('ring-2', 'ring-emerald-500/50', 'bg-emerald-500/10');
                        checkEndless.classList.remove('hidden');
                        checkRounds.classList.add('hidden');
                        roundInput.disabled = true;
                        roundInput.classList.add('opacity-30');
                    } else {
                        btnRounds.classList.add('ring-2', 'ring-emerald-500/50', 'bg-emerald-500/10');
                        btnEndless.classList.remove('ring-2', 'ring-rose-500/50', 'bg-rose-500/10');
                        checkRounds.classList.remove('hidden');
                        checkEndless.classList.add('hidden');
                        roundInput.disabled = false;
                        roundInput.classList.remove('opacity-30');
                    }
                }

                btnEndless.addEventListener('click', () => selectMode('endless'));
                btnRounds.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') selectMode('rounds');
                });
                roundInput.addEventListener('focus', () => selectMode('rounds'));
                
                // --- Difficulty Selection Logic ---
                const diffButtons = document.querySelectorAll('#difficulty-selector button');
                diffButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const difficultyKey = btn.getAttribute('data-difficulty');
                        gameState.difficulty = difficultyKey;
                        diffButtons.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        playClickSFX();
                    });
                });

                document.getElementById('start-battle').addEventListener('click', () => {
                    playClickSFX();
                    gameState.gameMode = selectedMode;
                    if (selectedMode === 'rounds') {
                        MAX_DEBATE_ROUNDS = parseInt(roundInput.value) || 4;
                    } else {
                        MAX_DEBATE_ROUNDS = 999; // Effectively infinite
                    }
                    renderStage5Battle();
                });

            } catch (e) {
                displayError(e.message);
            }
        }

        function renderStage5Battle() {
            const boss = gameState.bossCharacter;
            const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
            
            let html = `
                <div class="card p-6 mb-6 border-l-4 border-rose-500 bg-rose-900/10 flex justify-between items-center fade-in-up shadow-[0_4px_20px_rgba(244,63,94,0.1)]">
                    <div>
                        <h2 class="text-2xl font-black text-rose-400 tracking-wide drop-shadow-md">Phase 5: æœ€çµ‚æˆ°å ´</h2>
                        <p class="text-rose-300 text-sm font-bold opacity-80">é›£åº¦: ${difficulty.name} | ${gameState.gameMode === 'endless' ? 'ç„¡ç›¡æ¨¡å¼' : 'å›åˆæ¨¡å¼'}</p>
                    </div>
                    <div class="text-right w-1/3">
                        <p class="text-xs text-rose-400 font-bold mb-1 uppercase tracking-wider">é­”ç‹å£«æ°£ (HP)</p>
                        <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden relative border border-slate-700 shadow-inner">
                            <div id="boss-morale-bar-fill" class="h-full bg-gradient-to-r from-rose-600 to-rose-400 w-full transition-all duration-500 shadow-[0_0_10px_#f43f5e]"></div>
                        </div>
                        <p id="morale-value" class="text-sm text-rose-300 mt-1 font-mono font-bold">100%</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-6 h-[600px] fade-in-up" style="animation-delay: 0.1s">
                    <!-- Boss Profile & Logic Notes -->
                    <div class="md:w-1/3 flex flex-col space-y-4">
                        <div class="card p-6 text-center border-t-4 border-rose-500 h-fit bg-slate-900/60 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-full h-full bg-rose-500/5 pointer-events-none"></div>
                            <div class="text-8xl mb-4 emoji-icon animate-pulse drop-shadow-xl">${boss.icon}</div>
                            <h3 class="text-2xl font-bold text-white mb-1 drop-shadow-md">${boss.name}</h3>
                            <p class="text-rose-400 font-medium text-sm mb-4 bg-rose-500/10 inline-block px-3 py-1 rounded-full border border-rose-500/20">${boss.job} | ${boss.stance}</p>
                        </div>
                        
                        <!-- Logic Notes -->
                        <div class="card p-5 flex-grow border-t-4 border-amber-500 overflow-y-auto bg-slate-900/50 shadow-inner">
                            <h4 class="text-lg font-bold text-amber-400 mb-4 flex items-center border-b border-white/10 pb-3">
                                <span class="mr-2 text-xl">ğŸ“</span> æˆ°é¬¥æ—¥èªŒ
                            </h4>
                            <div id="logic-notes" class="space-y-4 text-sm text-slate-300">
                                <div>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2">--- åµæ¸¬åˆ°çš„è¬¬èª¤ ---</p>
                                    <div id="fallacy-log" class="space-y-2"></div>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 pt-2 border-t border-white/5">--- é—œéµè©å½™ ---</p>
                                    <div id="glossary-display" class="flex flex-wrap gap-2">
                                        ${Object.keys(gameState.glossary).map(term => 
                                            `<span id="term-${term}" class="glossary-term" onclick="showGlossaryDefinition('${term.replace(/'/g, "\\'")}')">${term}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Log & Input -->
                    <div class="md:w-2/3 flex flex-col h-full">
                        <div id="debate-log" class="flex-grow bg-black/20 border border-slate-700/50 p-6 rounded-2xl overflow-y-auto mb-4 space-y-6 scroll-smooth shadow-[inset_0_0_20px_rgba(0,0,0,0.3)]">
                            <!-- Logs -->
                        </div>
                        
                        <div class="relative shrink-0 card p-4 bg-slate-800/80 border-t border-white/10 shadow-2xl">
                            <textarea id="debate-input" rows="3" class="w-full p-4 text-lg" placeholder="> è¼¸å…¥é‚è¼¯åæ“Š..."></textarea>
                            
                            <div class="flex gap-3 mt-4">
                                <button id="surrender-btn" class="px-5 py-3 rounded-xl font-bold text-sm bg-slate-700/50 border border-slate-600 text-slate-400 hover:bg-slate-700 hover:text-white transition whitespace-nowrap">
                                    ğŸ³ï¸ æŠ•é™
                                </button>
                                <button id="hint-btn" class="flex-1 py-3 rounded-xl font-bold text-sm bg-amber-500/10 border border-amber-500/30 text-amber-400 hover:bg-amber-500/20 transition shadow-[0_0_10px_rgba(251,191,36,0.1)]">
                                    ğŸ’¡ ç´¢å–æç¤º
                                </button>
                                <button id="send-btn" class="flex-[2] soft-btn-secondary btn-base py-3 font-bold tracking-widest shadow-lg disabled:opacity-50">
                                    ç™¼é€åæ“Š
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            stages[5].innerHTML = html;

            gameState.debateHistory.push({speaker:'Boss', text:boss.initialComment});
            addLog('Boss', boss.initialComment, boss.icon);
            
            const sendBtn = document.getElementById('send-btn');
            const hintBtn = document.getElementById('hint-btn');
            const surrenderBtn = document.getElementById('surrender-btn');
            const input = document.getElementById('debate-input');
            const moraleBar = document.getElementById('boss-morale-bar-fill');
            const moraleVal = document.getElementById('morale-value');
            
            let currentRound = 1;
            const fallacyLog = document.getElementById('fallacy-log');
            const glossaryDisplay = document.getElementById('glossary-display');
            let loggedFallacies = [];

            // Input validation for enabling/disabling send button
            input.addEventListener('input', () => {
                sendBtn.disabled = input.value.trim().length < 5;
            });
            sendBtn.disabled = true;

            surrenderBtn.addEventListener('click', async () => {
                displayModal('ç¢ºèªæŠ•é™', 
                    `<p class="text-xl font-bold text-white mb-2">ç¢ºå®šè¦æ”¾æ£„è¾¯è«–å—ï¼Ÿ</p>
                     <p class="text-rose-400">é…¸æ°‘å°‡ç²å¾—å‹åˆ©ï¼Œè€ŒçœŸç›¸å°‡è¢«æ©è“‹ã€‚</p>`,
                    `
                    <button class="soft-btn-danger btn-base px-6 py-3 shadow-lg" onclick="
                        gameState.isSurrender = true; 
                        document.getElementById('modal-container').innerHTML = ''; 
                        finishBattle();
                    ">å¿ç—›æ”¾æ£„</button>
                    <button class="bg-slate-700 text-white px-6 py-3 rounded-xl hover:bg-slate-600" onclick="document.getElementById('modal-container').innerHTML = ''">å–æ¶ˆ</button>
                    `
                );
            });

            hintBtn.addEventListener('click', async () => {
                playClickSFX();
                if (input.disabled) return;
                hintBtn.disabled = true;
                hintBtn.innerHTML = '<span class="animate-pulse">åˆ†æå¼±é»ä¸­...</span>';
                try {
                    const lastBossArg = gameState.debateHistory.filter(h => h.speaker === 'Boss').pop().text;
                    const hintRes = await getHint(lastBossArg, input.value, boss.fallacies);
                    
                    if (hintRes.keyTerm && hintRes.termDefinition) {
                        const term = hintRes.keyTerm;
                        const definition = hintRes.termDefinition;
                        
                        if (gameState.glossary[term] !== definition) {
                            gameState.glossary[term] = definition;
                            if (!document.getElementById(`term-${term}`)) {
                                const termHtml = `<span id="term-${term}" class="glossary-term" onclick="showGlossaryDefinition('${term.replace(/'/g, "\\'")}')">${term}</span>`;
                                glossaryDisplay.innerHTML += termHtml;
                            }
                        }
                    }

                    displayModal('æˆ°è¡“æç¤º', 
                        `<div class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                            <p class="text-amber-400 text-lg mb-2 font-bold flex items-center"><span class="text-2xl mr-2">ğŸ’¡</span>å»ºè­°ç­–ç•¥</p>
                            <p class="text-white leading-relaxed">${parseText(hintRes.hintText)}</p>
                        </div>`);

                } catch(e) { 
                    displayError(e.message);
                } finally {
                    hintBtn.disabled = false;
                    hintBtn.innerHTML = 'ğŸ’¡ ç´¢å–æç¤º';
                }
            });

            sendBtn.addEventListener('click', async () => {
                playClickSFX();
                const txt = input.value.trim();
                if (txt.length < 5) return;
                
                input.value = '';
                input.disabled = true;
                sendBtn.disabled = true;
                hintBtn.disabled = true;
                surrenderBtn.disabled = true;

                addLog('User', txt, 'ğŸ‘¤');
                gameState.debateHistory.push({speaker:'User', text:txt});

                if (gameState.gameMode === 'rounds' && currentRound >= MAX_DEBATE_ROUNDS) {
                     finishBattle();
                     return;
                }

                // --- MODIFIED PROMPT FOR DIFFICULTY ---
                let difficultyInstruction = "";
                if (gameState.difficulty === 'EASY') {
                    // Specific instruction for Easy mode: weak logic, poor speech, hard to talk back
                    difficultyInstruction = "ä½ æ˜¯ã€éµç›¤å°å±å­©ã€ã€‚é‚è¼¯æ¥µå·®ï¼Œè©å½™é‡å°‘ï¼Œåªæœƒç”¨é«’è©±æˆ–é‡è¤‡çš„è©±èªä¾†å›å˜´ã€‚å¦‚æœç©å®¶çš„åæ“Šæœ‰ç†ï¼Œä½ æ‡‰è©²è¡¨ç¾å‡ºæƒ±ç¾æˆæ€’ä½†åˆèªªä¸å‡ºå€‹æ‰€ä»¥ç„¶çš„æ¨£å­ï¼Œæˆ–è€…ç›´æ¥èªå¡ã€è·³é‡ï¼Œå¾ˆé›£æœ‰åŠ›åœ°åæ“Šã€‚è«‹è¡¨ç¾å‡ºã€è¢«å˜´çˆ†ã€çš„æ„Ÿè¦ºã€‚";
                } else if (gameState.difficulty === 'HARD') {
                    difficultyInstruction = "ä½ æ˜¯é‚è¼¯åš´è¬¹çš„è¾¯è«–å°ˆå®¶ï¼Œè«‹å˜—è©¦æ‰¾å‡ºç©å®¶è«–é»çš„æ¼æ´é€²è¡Œåæ“Šã€‚åŒæ™‚ï¼Œè«‹æŒ‡æ˜é…¸æ°‘æœ¬æ¬¡å›æ‡‰ä¸­ä½¿ç”¨çš„ã€Œé‚è¼¯è¬¬èª¤ã€å°ˆæ¥­åç¨±ï¼Œä¾‹å¦‚: ç¨»è‰äººè¬¬èª¤ã€‚";
                } else {
                    difficultyInstruction = "ä½ æ˜¯ã€ç¤¾ç¾¤å˜´ç ²ç‹ã€ã€‚æœ‰åŸºæœ¬é‚è¼¯ï¼Œä½†å®¹æ˜“è¢«æƒ…ç·’å¸¶å‹•ã€‚å¦‚æœç©å®¶èªªå¾—æœ‰é“ç†ï¼Œä½ æœƒå—åˆ°å‚·å®³ï¼ˆæ‰£å£«æ°£ï¼‰ï¼Œä½†å˜´å·´é‚„æ˜¯å¾ˆç¡¬ã€‚è«‹è¡¨ç¾å‡ºä¸€èˆ¬ç¶²æ°‘åµæ¶çš„æ¨£å­ã€‚åŒæ™‚ï¼Œè«‹åœ¨ 'logicalFallacy' æ¬„ä½ä¸­ï¼Œç”¨ç°¡å–®ç™½è©±æ–‡æŒ‡å‡ºå°æ–¹é‚è¼¯ä¸Šçš„ç›²é»æˆ–éŒ¯èª¤ï¼Œ**ä¸è¦**ä½¿ç”¨å°ˆæ¥­çš„è¬¬èª¤è¡“èªã€‚";
                }

                const prompt = `é…¸æ°‘å›æ‡‰ï¼š${JSON.stringify(gameState.debateHistory)}ã€‚ç©å®¶æœ€æ–°ï¼š${txt}ã€‚å …æŒèª¤è®€ï¼Œæƒ…ç·’åŒ–ã€‚è«‹æ ¹æ“šç©å®¶åé§çš„æœ‰æ•ˆæ€§çµ¦äºˆ moraleChange (è² æ•¸ä»£è¡¨é…¸æ°‘å—å‚·ï¼Œæ­£æ•¸ä»£è¡¨é…¸æ°‘å¾—æ„)ã€‚${difficultyInstruction}`;
                
                try {
                    const bossRes = await apiCall(createPayload(prompt, bossResponseSchema));
                    
                    const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
                    let change = bossRes.moraleChange || -10; 
                    
                    if (change < 0) {
                        change = Math.round(change / difficulty.moraleMultiplier); 
                    } else {
                        change = Math.round(change * difficulty.moraleMultiplier); 
                    }

                    gameState.bossMorale = Math.max(0, Math.min(100, gameState.bossMorale + change));
                    
                    playBossResponseSFX();
                    addLog('Boss', bossRes.bossResponse, boss.icon, bossRes.statusMessage);
                    gameState.debateHistory.push({speaker:'Boss', text:bossRes.bossResponse, fallacy: bossRes.logicalFallacy, moraleChange: change});
                    
                    if (bossRes.logicalFallacy && !loggedFallacies.includes(bossRes.logicalFallacy)) {
                        loggedFallacies.push(bossRes.logicalFallacy);
                        fallacyLog.innerHTML += `
                            <div class="flex items-start text-xs text-rose-300 font-bold bg-rose-500/10 p-2 rounded border border-rose-500/20">
                                <span class="text-rose-500 mr-2 shrink-0">ğŸš¨</span> 
                                <span>åµæ¸¬åˆ°: ${bossRes.logicalFallacy}</span>
                            </div>
                        `;
                        fallacyLog.scrollTop = fallacyLog.scrollHeight;
                    }


                    moraleBar.style.width = `${gameState.bossMorale}%`;
                    moraleVal.textContent = `${gameState.bossMorale}%`;
                    
                    const moraleContainer = document.getElementById('boss-morale-bar-fill').parentElement;
                    if(change < 0) {
                        moraleContainer.classList.add('ring-2', 'ring-emerald-500', 'shadow-[0_0_15px_#10b981]');
                        setTimeout(() => moraleContainer.classList.remove('ring-2', 'ring-emerald-500', 'shadow-[0_0_15px_#10b981]'), 500);
                    } else {
                        moraleContainer.classList.add('ring-2', 'ring-rose-500', 'shadow-[0_0_15px_#f43f5e]');
                        setTimeout(() => moraleContainer.classList.remove('ring-2', 'ring-rose-500', 'shadow-[0_0_15px_#f43f5e]'), 500);
                    }

                    if (gameState.bossMorale <= 0) {
                        setTimeout(finishBattle, 1000);
                        return;
                    }

                    currentRound++;
                } catch(e) {
                    displayError(e.message);
                } finally {
                    input.disabled = false;
                    sendBtn.disabled = input.value.trim().length < 5;
                    hintBtn.disabled = false;
                    surrenderBtn.disabled = false;
                }
            });
        }

        async function finishBattle() {
            toggleLoading(true, 'ç”Ÿæˆæœ€çµ‚å ±å‘Š...');
            
            const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
            let context = `ç©å®¶æ˜¯å¦æŠ•é™: ${gameState.isSurrender}ã€‚é…¸æ°‘å‰©é¤˜å£«æ°£: ${gameState.bossMorale}ã€‚éŠæˆ²æ¨¡å¼: ${gameState.gameMode}ã€‚ç©å®¶ F/O/J éšæ®µå¾—åˆ†: ${gameState.fojScore}ã€‚`;
            let isRoundWin = false;
            
            let resultType = "NORMAL";
            
            if (gameState.isSurrender) {
                context += " ç©å®¶ä¸»å‹•æ”¾æ£„ï¼Œé…¸æ°‘ç²å¾—å‹åˆ©ã€‚";
                resultType = "SURRENDER";
            } else if (gameState.bossMorale <= 0) {
                context += " é…¸æ°‘å£«æ°£å´©æ½°ï¼Œç©å®¶ç²å¾—å£“å€’æ€§å‹åˆ©ã€‚";
                resultType = "KO";
            } else if (gameState.gameMode === 'rounds') {
                 context += " å›åˆçµæŸã€‚è«‹æ ¹æ“šç©å®¶è¡¨ç¾çµ¦äºˆè©•åˆ†èˆ‡å»ºè­°ã€‚";
                 resultType = "ROUNDS_END";
            }
            
            const prompt = `è©•å¯©è¾¯è«–æ­·å²ï¼š${JSON.stringify(gameState.debateHistory)}ã€‚æƒ…å¢ƒèƒŒæ™¯ï¼š${context}ã€‚
è«‹é‡å°ç©å®¶è¡¨ç¾ï¼Œæä¾›3å€‹å…·é«”çš„ã€Œè¾¯è«–å„ªåŒ–å»ºè­°ã€(debateSuggestions)ã€‚
**é‡è¦ï¼šæœ€çµ‚é‚è¼¯åˆ†æ•¸(logicScore)å¿…é ˆç¶œåˆè€ƒæ…®ç©å®¶åœ¨ F/O éšæ®µçš„å¾—åˆ†(max 100)èˆ‡é­”ç‹æˆ°çš„è¡¨ç¾(å£«æ°£æ‰£æ¸›å¤šå¯¡)ä¾†è¨ˆç®—ã€‚**
å¦‚æœæ˜¯åœ¨æˆ°è¡“å›åˆåˆ¶ä¸­çµæŸï¼Œè«‹ä¸è¦åˆ¤å®šç‚ºå¤±æ•—ï¼Œè€Œæ˜¯çµ¦äºˆä¸€å€‹å®¢è§€çš„æºé€šæ•ˆèƒ½è©•åˆ†ã€‚`;

            try {
                const evalRes = await apiCall(createPayload(prompt, evaluationSchema));
                gameState.evaluation = evalRes;
                renderStage6(resultType); 
                showStage(6);
            } catch(e) {
                displayError(e.message);
            } finally {
                toggleLoading(false);
            }
        }

        function addLog(speaker, text, icon, status) {
            const log = document.getElementById('debate-log');
            const isUser = speaker === 'User';
            const parsedText = parseText(text);
            
            const html = `
                <div class="flex ${isUser ? 'justify-end log-entry-user' : 'justify-start log-entry-boss'} mb-6">
                    <div class="dialog-bubble p-5 max-w-[85%] relative group ${isUser ? 'bg-indigo-900/30 border-indigo-500/30' : 'bg-slate-800/60'}">
                        <div class="absolute -top-4 ${isUser ? '-right-3' : '-left-3'} text-3xl drop-shadow-lg group-hover:scale-110 transition-transform">${icon}</div>
                        <p class="text-base leading-relaxed font-sans text-slate-200">${parsedText}</p>
                        ${status ? `<p class="text-xs text-amber-400 mt-3 font-mono border-t border-white/10 pt-2 uppercase font-bold flex items-center"><span class="w-1.5 h-1.5 bg-amber-400 rounded-full mr-2 animate-pulse"></span>ç‹€æ…‹: ${status}</p>` : ''}
                    </div>
                </div>
            `;
            log.innerHTML += html;
            log.scrollTop = log.scrollHeight;
        }

        // ----------------------------------------------------
        // 12. Stage 6: Evaluation (Renamed from Stage 5)
        // ----------------------------------------------------
        function renderStage6(resultType) {
            const { logicScore, debateCritique, debateSuggestions, finalBossVerdict } = gameState.evaluation;
            const boss = gameState.bossCharacter;
            
            // --- Determine Display Title ---
            let resultTitle = '';
            let resultIcon = '';
            let titleColor = '';
            
            if (resultType === 'SURRENDER') {
                resultTitle = 'ä»»å‹™ä¸­æ­¢';
                resultIcon = 'ğŸ³ï¸';
                titleColor = 'text-slate-500';
                playFailureSFX();
            } else if (resultType === 'KO') {
                resultTitle = 'å®Œå…¨å‹åˆ©';
                resultIcon = 'ğŸ†';
                titleColor = 'text-emerald-400 drop-shadow-[0_0_15px_rgba(52,211,153,0.6)]';
                playSuccessSFX();
            } else { // ROUNDS_END
                resultTitle = 'å›åˆçµæŸ';
                resultIcon = 'â±ï¸';
                titleColor = 'text-indigo-400 drop-shadow-[0_0_15px_rgba(99,102,241,0.6)]';
                playSuccessSFX();
            }

            let html = `
                <div class="card p-12 text-center border-t-8 border-slate-600 fade-in-up shadow-2xl">
                    <div class="mb-8">
                        <span class="text-8xl filter drop-shadow-2xl animate-bounce">${resultIcon}</span>
                    </div>
                    <h1 class="text-5xl font-black mb-2 ${titleColor} tracking-tight uppercase">
                        ${resultTitle}
                    </h1>
                    <p class="text-slate-400 font-bold tracking-[0.2em] mb-12 uppercase text-sm">Final Evaluation Report</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                        <div class="bg-amber-900/10 p-8 border border-amber-600/30 rounded-3xl relative overflow-hidden group">
                            <div class="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <h3 class="text-amber-400 font-bold mb-4 flex items-center uppercase text-sm tracking-wider">
                                <span class="w-2 h-2 bg-amber-400 rounded-full mr-3"></span>é‚è¼¯è©•åˆ†
                            </h3>
                            <div class="text-7xl font-black text-white mb-4 tracking-tighter drop-shadow-lg">${logicScore}<span class="text-2xl text-slate-500 font-normal ml-2">/100</span></div>
                            <p class="text-sm text-slate-300 leading-relaxed">${parseText(debateCritique)}</p>
                            <p class="text-xs text-slate-500 mt-4 pt-4 border-t border-white/10 font-mono">Phase 1 Bonus: +${gameState.fojScore}</p>
                        </div>
                        
                        <div class="bg-indigo-900/10 p-8 border border-indigo-600/30 rounded-3xl relative overflow-hidden group">
                            <div class="absolute inset-0 bg-indigo-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <h3 class="text-indigo-400 font-bold mb-4 flex items-center uppercase text-sm tracking-wider">
                                <span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>å°æ‰‹ç‹€æ…‹
                            </h3>
                            <div class="flex items-center mb-6 bg-slate-900/50 p-4 border border-slate-700/50 rounded-2xl">
                                <span class="text-5xl mr-4 emoji-icon filter drop-shadow-lg">${boss.icon}</span>
                                <div>
                                    <span class="text-white font-bold text-xl block">${boss.name}</span>
                                    <span class="text-sm text-slate-400">${boss.age}æ­² / ${boss.job}</span>
                                </div>
                            </div>
                            <p class="text-white italic text-sm border-l-2 border-indigo-500 pl-4 mb-4 leading-relaxed opacity-80">"${parseText(finalBossVerdict)}"</p>
                            <p class="text-xs text-slate-500 mt-auto text-right font-mono uppercase tracking-wider">FINAL MORALE: ${gameState.bossMorale}%</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 bg-emerald-900/10 p-8 border border-emerald-600/30 text-left rounded-3xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1.5 h-full bg-emerald-500"></div>
                        <h3 class="text-emerald-400 font-bold mb-4 flex items-center uppercase text-sm tracking-wider">
                            <span class="text-xl mr-2">ğŸ’¡</span> æˆ°è¡“å»ºè­°
                        </h3>
                        <ul class="list-disc pl-5 space-y-3 text-slate-300 text-sm leading-relaxed">
                            ${debateSuggestions ? debateSuggestions.map(s => `<li>${parseText(s)}</li>`).join('') : '<li>ç„¡è³‡æ–™</li>'}
                        </ul>
                    </div>

                    <button onclick="window.location.reload()" class="mt-12 soft-btn btn-base px-12 py-5 text-xl font-bold shadow-2xl hover:scale-105 transform transition">
                        é‡æ–°å•Ÿå‹•ç³»çµ± (REBOOT)
                    </button>
                </div>
            `;
            stages[6].innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            stageDisplay = document.getElementById('current-stage-display');
            gameContent = document.getElementById('game-container');
            loadingState = document.getElementById('loading-state');
            errorState = document.getElementById('error-state');
            loadingMessage = document.getElementById('loading-message');
            
            stages = {
                0: document.getElementById('stage-0'),
                1: document.getElementById('stage-1'),
                2: document.getElementById('stage-2'), 
                3: document.getElementById('stage-3'), 
                4: document.getElementById('stage-4'), 
                5: document.getElementById('stage-5'), 
                6: document.getElementById('stage-6'),
            };
            
            function showIntroModal() {
                const intro = document.getElementById('intro-modal');
                intro.classList.remove('hidden');
                
                document.getElementById('close-intro-btn').addEventListener('click', () => {
                    intro.classList.add('hidden');
                    localStorage.setItem('troll_be_gone_intro_seen_soft_v2', 'true');
                    playClickSFX();
                });
            }

            if (!localStorage.getItem('troll_be_gone_intro_seen_soft_v2')) {
                showIntroModal();
            }

            // Setup Listeners
            document.getElementById('bgm-toggle').addEventListener('click', () => {
                if (!isAudioInitialized) initializeAudio();
                else isBGMPlaying ? stopBGM() : startBGM();
            });

            document.getElementById('instructions-button').addEventListener('click', () => {
                playClickSFX();
                displayModal('éŠæˆ²èªªæ˜èˆ‡ç›®æ¨™', 
                    `<div class="space-y-4 text-left">
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 0: é¸æ“‡æˆ°å ´</h4>
                            <p class="text-sm">é¸æ“‡ä¸€å€‹ä½ æ„Ÿèˆˆè¶£çš„çˆ­è­°è©±é¡Œï¼Œæˆ–è¼¸å…¥ä¸€ç¯‡è²¼æ–‡ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 1: é‚è¼¯æ‹†è§£ (äº‹å¯¦/è§€é»)</h4>
                            <p class="text-sm">åˆ†ææ–‡ä¸­çš„å¥å­æ˜¯äº‹å¯¦æˆ–è§€é»ï¼Œæ¯ç­”å°ä¸€é¡Œå¯ç²å¾— <strong class="text-yellow-300 font-bold">20 åˆ†</strong>çš„åŸºç¤åˆ†æ•¸ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 2: è§’è‰²æ¨¡æ“¬</h4>
                            <p class="text-sm">æ›ä½æ€è€ƒã€‚æ‰®æ¼”ä¸€å€‹ç‰¹å®šç«‹å ´çš„è§’è‰²ï¼Œæ¨¡æ“¬ç™¼è¨€ã€‚AIå°‡ä»¥<strong class="text-red-400">æ¥µåš´æ ¼çš„æ¨™æº–</strong>è©•åˆ†ä½ çš„æ¨¡ä»¿ç¨‹åº¦ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 3: è¼¿è«–è§€å¯Ÿ</h4>
                            <p class="text-sm">è§€å¯Ÿå ´ä¸Šä¸åŒè§’è‰²çš„ç™¼è¨€ï¼Œè’é›†æƒ…å ±ï¼Œä¸¦è¤‡ç¿’é—œéµè¡“èªã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-red-400 font-bold mb-1">Step 4: é­”ç‹æˆ° (éµç›¤å°å³™)</h4>
                            <p class="text-sm">é¢å°ä¸€å€‹ã€Œæ²’çœ‹å…§æ–‡å°±é–‹å™´ã€çš„é…¸æ°‘ã€‚ç›®æ¨™æ˜¯é€é<strong class="text-red-400">é‚è¼¯åæ“Š</strong>å°‡å…¶å£«æ°£é™è‡³é›¶ã€‚å›åˆæ¨¡å¼ä¸‹ï¼Œå°ˆæ³¨æ–¼æºé€šæ•ˆæœçš„è©•åˆ†ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-purple-400 font-bold mb-1">Step 5: çµç®—</h4>
                            <p class="text-sm">AI è£åˆ¤å°‡ç¶œåˆ F/O è¡¨ç¾å’Œé­”ç‹æˆ°çµæœï¼Œçµ¦å‡ºä½ çš„æœ€çµ‚é‚è¼¯å¼·åº¦è©•åˆ†ã€‚</p>
                        </div>
                        <div class="mt-4 text-right">
                             <button id="replay-intro-btn" class="text-xs text-indigo-400 hover:text-indigo-300 underline">é‡çœ‹å‰æƒ…æè¦</button>
                        </div>
                    </div>`);
                    
                    // Add listener for the replay button inside the modal
                    setTimeout(() => {
                         const replayBtn = document.getElementById('replay-intro-btn');
                         if(replayBtn) {
                             replayBtn.addEventListener('click', () => {
                                 document.getElementById('modal-container').innerHTML = ''; // Close current
                                 showIntroModal(); // Show intro
                             });
                         }
                    }, 100);
            });

            if (!apiKey) {
                renderApiKeyInput();
                showStage(0);
                return;
            }

            renderTopicSelection(); // Was renderStage0
            showStage(0);
        });
    </script>
</body>
</html>