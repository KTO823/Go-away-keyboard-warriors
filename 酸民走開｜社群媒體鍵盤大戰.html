<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…¸æ°‘èµ°é–‹ï½œç¤¾ç¾¤åª’é«”éµç›¤å¤§æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Firebase SDKs for Persistence -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <script defer>
        // ----------------------------------------------------------------------
        // API Key è¼¸å…¥æç¤º
        // ----------------------------------------------------------------------
        const apiKey = ""; // <--- API Key å°‡åœ¨åŸ·è¡Œæ™‚è‡ªå‹•å¡«å…¥
        
        // ----------------------------------------------------------------------
        // Firebase è¨­å®šèˆ‡åˆå§‹åŒ–é‚è¼¯
        // ----------------------------------------------------------------------
        
        if (typeof firebase !== 'undefined' && firebase.firestore) {
            firebase.firestore.setLogLevel('Debug');
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        try {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            firebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }
        
        window.db = null;
        window.auth = null;
        window.userId = 'Loading...'; 
        
        window.firebaseSetup = async () => {
            if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                console.error("Firebase SDK æœªè¼‰å…¥ã€‚");
                window.userId = 'SDK Error';
                const idDisplayEl = document.getElementById('user-id-display');
                if(idDisplayEl) { idDisplayEl.textContent = `ä½¿ç”¨è€… ID: ${window.userId}`; }
                return;
            }

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase configuration is missing, running without persistence.");
                    window.userId = 'Anonymous (No DB)';
                    const idDisplayEl = document.getElementById('user-id-display');
                    if(idDisplayEl) { idDisplayEl.textContent = `ä½¿ç”¨è€… ID: ${window.userId}`; }
                    return;
                }
                
                const app = firebase.initializeApp(firebaseConfig);
                window.db = firebase.firestore(app);
                window.auth = firebase.auth(app);

                firebase.auth(app).onAuthStateChanged(async (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                const userCredential = await firebase.auth(app).signInWithCustomToken(initialAuthToken);
                                window.userId = userCredential.user.uid;
                            } else {
                                const userCredential = await firebase.auth(app).signInAnonymously();
                                window.userId = userCredential.user.uid;
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error (Fallback to Anonymous):", error);
                            window.userId = 'Auth Failed';
                        }
                    }
                    const idDisplayEl = document.getElementById('user-id-display');
                    if(idDisplayEl) { idDisplayEl.textContent = `ä½¿ç”¨è€… ID: ${window.userId}`; }
                });
            } catch (setupError) {
                console.error("FATAL Firebase Setup Error:", setupError);
                window.userId = 'Setup Failed';
                const idDisplayEl = document.getElementById('user-id-display');
                if(idDisplayEl) { idDisplayEl.textContent = `ä½¿ç”¨è€… ID: ${window.userId}`; }
            }
        };

        window.firebaseSetup();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+TC:wght@300;500;700&display=swap');
        
        /* åŸºç¤æ¨£å¼ - æ›´åŠ æŸ”å’Œå”èª¿ */
        body {
            font-family: 'Noto Sans TC', 'Nunito', sans-serif;
            background-color: #121218; 
            color: #e4e4e7;
            /* æŸ”å’Œçš„èƒŒæ™¯å…‰æšˆ */
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.15), transparent 25%);
            background-attachment: fixed;
        }
        
        .arena-bg {
            background: rgba(30, 30, 40, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
        }

        /* å¡ç‰‡æ¨£å¼ï¼šåœ“æ½¤ã€æŸ”å’Œé™°å½± */
        .card {
            background-color: rgba(40, 40, 55, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 1rem; /* æŸ”å’Œåœ“è§’ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        
        /* æŒ‰éˆ•æ¨£å¼ï¼šåœ“æ½¤ã€æ¼¸å±¤ */
        .soft-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: #064e3b;
            font-weight: 700;
            border-radius: 0.75rem; 
            border: none;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }
        .soft-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(16, 185, 129, 0.4);
            filter: brightness(1.1);
        }
        .soft-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        
        .soft-btn-secondary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        .soft-btn-secondary:hover:not(:disabled) {
            box-shadow: 0 8px 12px rgba(79, 70, 229, 0.4);
        }

        .soft-btn-danger {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
        }
        
        .soft-btn-difficulty {
            background: rgba(60, 60, 70, 0.5);
            border: 2px solid transparent;
        }
        .soft-btn-difficulty.selected {
            background: rgba(79, 70, 229, 0.3);
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
        }

        /* èªªæ˜èˆ‡éŸ³æ¨‚æŒ‰éˆ• */
        .util-btn {
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
            font-size: 1.2rem;
        }
        .util-btn:hover {
            transform: scale(1.1);
        }

        /* å‹•ç•« */
        .character-enter {
            animation: floatUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .emoji-icon {
            display: inline-block;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .dialog-bubble {
            transform: scale(0.95);
            opacity: 0;
            animation: softPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            border-radius: 1rem;
            border-bottom-left-radius: 0.2rem;
        }
        @keyframes softPop {
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes floatUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stage-transition {
            animation: floatUp 0.6s ease-out forwards;
        }

        /* è¾¯è«–ç´€éŒ„ */
        .log-entry-user { animation: slideLeft 0.4s ease-out forwards; }
        .log-entry-boss { animation: slideRight 0.4s ease-out forwards; }
        @keyframes slideLeft { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
        @keyframes slideRight { from { opacity:0; transform:translateX(10px); } to { opacity:1; transform:translateX(0); } }

        /* å£«æ°£æ¢ */
        #boss-morale-bar-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .strike-through {
            text-decoration: line-through;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1e1e26;
            padding: 2.5rem;
            border-radius: 1.5rem;
            max-width: 90%; width: 650px;
            max-height: 85vh; overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        strong {
            color: #fbbf24;
            font-weight: 700;
        }
        
        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Loading Spinner Animation */
        .loader {
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        /* Glossary term style */
        .glossary-term {
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none; /* remove underline by default */
        }
        .glossary-term:hover {
            filter: brightness(1.2);
            text-decoration: underline;
        }
    </style>
</head>
<body class="min-h-screen p-3 md:p-6 flex items-center justify-center">

    <div id="game-container" class="w-full max-w-5xl arena-bg rounded-3xl shadow-2xl p-6 md:p-10 border-t-4 border-emerald-400">
        
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center relative border-b border-gray-700/50 pb-6">
            <div class="text-center md:text-left">
                <h1 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 tracking-tight mb-2">
                    <span class="emoji-icon">ğŸ§ </span> éµç›¤å¤§æˆ° <span class="text-gray-500 font-light text-2xl mx-2">|</span> é…¸æ°‘èµ°é–‹
                </h1>
                <p id="current-stage-display" class="text-sm font-medium text-gray-400 tracking-wider">ç³»çµ±æº–å‚™å°±ç·’</p>
                <p id="user-id-display" class="text-xs text-gray-600 mt-1 font-mono">ID: ...</p>
            </div>

            <!-- Tools -->
            <div class="flex space-x-3 mt-4 md:mt-0">
                <button id="bgm-toggle" class="util-btn bg-gray-700 text-pink-400 hover:bg-gray-600 hover:text-pink-300" aria-label="Toggle BGM">
                    â™«
                </button>
                <button id="instructions-button" class="util-btn bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-500/30" aria-label="Instructions">
                    â”
                </button>
            </div>
        </header>

        <!-- Error Alert -->
        <div id="error-state" class="hidden card p-4 mb-6 text-red-300 border-red-500/50 border bg-red-900/10 flex items-center rounded-xl">
            <span class="text-2xl mr-3">âš ï¸</span>
            <div>
                <p class="font-bold">é€£ç·šä¸­æ–·</p>
                <p id="error-message-detail" class="text-sm opacity-80">è«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®šã€‚</p>
            </div>
        </div>

        <!-- Sticky Scenario (Persistent) -->
        <div id="scenario-display-container" class="hidden mb-8 transition-all duration-500">
            <div class="card p-5 border-l-4 border-emerald-500 bg-gray-800/40 backdrop-blur-sm rounded-xl">
                <h3 class="text-sm font-bold text-emerald-400 mb-3 flex items-center tracking-wider uppercase">
                    <span class="mr-2">ğŸ“„</span> Target Post (åŸè²¼æ–‡)
                </h3>
                <div id="scenario-content-display" class="p-4 rounded-lg bg-gray-900/50 border border-gray-700/50 max-h-48 overflow-y-auto text-base text-gray-200 leading-relaxed font-light">
                    <!-- Content injected -->
                </div>
            </div>
        </div>


        <!-- Game Content Area -->
        <div id="game-content" class="min-h-[400px]">
            
            <!-- Stage 0: Setup -->
            <div id="stage-0" class="space-y-6"></div>

            <!-- Stage 1: Logic Analysis -->
            <div id="stage-1" class="hidden"></div>

            <!-- Stage 2: Role Simulation -->
            <div id="stage-2" class="hidden"></div>

            <!-- Stage 3: Community Observation -->
            <div id="stage-3" class="hidden"></div>

            <!-- Stage 4: Boss Battle -->
            <div id="stage-4" class="hidden"></div>

            <!-- Stage 5: Evaluation -->
            <div id="stage-5" class="hidden"></div>

            <!-- Loading - åŠ äº†è½‰åœˆåœˆ -->
            <div id="loading-state" class="hidden flex flex-col items-center justify-center h-64 py-12">
                <div class="relative w-16 h-16 mb-6">
                    <div class="w-full h-full border-4 border-emerald-500/30 rounded-full"></div>
                    <div class="absolute top-0 left-0 w-full h-full border-4 border-emerald-500 rounded-full loader border-t-transparent"></div>
                </div>
                <p id="loading-message" class="text-emerald-400 font-medium tracking-widest animate-pulse">AI æ­£åœ¨é‹ç®—ä¸­...</p>
            </div>
            
        </div>

    </div>
    
    <!-- Modal -->
    <div id="modal-container"></div>

    <script defer>
        // ----------------------------------------------------
        // 1. Config & Difficulty Settings
        // ----------------------------------------------------
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        let MAX_DEBATE_ROUNDS = 4; // Default, will be dynamic

        // NEW: é›£åº¦è¨­å®š
        const DIFFICULTY_SETTINGS = {
            EASY: {
                key: 'EASY',
                name: "éµç›¤å°å±å­©",
                description: "å®¹æ˜“è¢«æƒ…ç·’å½±éŸ¿ï¼Œé‚è¼¯è–„å¼±ã€‚",
                icon: "ğŸ‘¶",
                moraleMultiplier: 0.5, // ç©å®¶å‚·å®³ x 2
                winThreshold: 0.4 // å›åˆåˆ¶æ¨¡å¼ä¸­ï¼Œå£«æ°£å‰Šå¼± 40% å³å¯åˆ¤å®šå‹åˆ©
            },
            MEDIUM: {
                key: 'MEDIUM',
                name: "ç¤¾ç¾¤å˜´ç ²ç‹",
                description: "æœ‰ä¸€å®šçš„åé§èƒ½åŠ›ï¼Œé‚è¼¯æˆ°åŠ›å¹³å‡ã€‚",
                icon: "ğŸ—£ï¸",
                moraleMultiplier: 1.0, 
                winThreshold: 0.6 // å£«æ°£å‰Šå¼± 60%
            },
            HARD: {
                key: 'HARD',
                name: "å°ˆå®¶è¾¯è«–å®¶",
                description: "é‚è¼¯åš´è¬¹ï¼Œæ¥µé›£æ“Šæ•—ï¼Œå£«æ°£é›£ä»¥æ’¼å‹•ã€‚",
                icon: "ğŸ§ ",
                moraleMultiplier: 1.5, // ç©å®¶å‚·å®³ x 0.66
                winThreshold: 0.8 // å£«æ°£å‰Šå¼± 80%
            }
        };

        const gameState = {
            currentStage: 0, 
            scenario: '',          
            scenarioCategory: '',  
            gameData: null,        
            userFactChecks: null,  
            fojScore: 0,           
            glossary: {},          
            
            assignedRoleIndex: null, 
            userRoleArgument: null,  
            rolePlayCritique: null,  

            difficulty: 'MEDIUM',    // NEW: å„²å­˜é›£åº¦ç­‰ç´š
            bossCharacter: null,     
            debateHistory: [],       
            bossMorale: 100,         
            gameMode: 'rounds', 
            isSurrender: false,

            evaluation: null
        };
        
        let stageDisplay, gameContent, loadingState, errorState, errorMessageDetail, loadingMessage;
        let stages = {};

        // Helper: Markdown Bold
        function parseText(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-yellow-400">$1</strong>');
        }

        // ----------------------------------------------------
        // 2. Audio (Tone.js) - Smooth Ambient
        // ----------------------------------------------------
        
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" }, // Softer sound
            envelope: { attack: 0.05, decay: 0.2, sustain: 0.2, release: 1.5 }
        }).toDestination();
        synth.volume.value = -5;

        const clickSynth = new Tone.MembraneSynth().toDestination();
        clickSynth.volume.value = -12;

        // BGM
        const bgmPad = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: { attack: 1, decay: 1, sustain: 0.8, release: 3 }
        }).toDestination();
        bgmPad.volume.value = -15;

        let bgmLoop = null;
        let isAudioInitialized = false;
        let isBGMPlaying = false;

        function playClickSFX() {
            if (isAudioInitialized) clickSynth.triggerAttackRelease("C2", "32n");
        }

        function playSuccessSFX() {
            if (isAudioInitialized) {
                synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "4n");
            }
        }

        function playFailureSFX() {
            if (isAudioInitialized) {
                synth.triggerAttackRelease(["A3", "E3", "C3"], "8n");
            }
        }
        
        function playBossResponseSFX() {
            if (isAudioInitialized) synth.triggerAttackRelease(["G2", "D3"], "8n");
        }

        function startBGM() {
            if (!isAudioInitialized || isBGMPlaying) return;

            const chords = [
                ["C3", "E3", "G3", "B3"],
                ["A2", "C3", "E3", "G3"],
                ["F2", "A2", "C3", "E3"],
                ["G2", "B2", "D3", "F3"]
            ];
            let chordIndex = 0;

            bgmLoop = new Tone.Loop(time => {
                bgmPad.triggerAttackRelease(chords[chordIndex % chords.length], "2n", time);
                chordIndex++;
            }, "1n").start(0);

            Tone.Transport.bpm.value = 60; // Slower, relaxed tempo
            Tone.Transport.start();
            isBGMPlaying = true;
            document.getElementById('bgm-toggle').textContent = 'â¸';
            document.getElementById('bgm-toggle').classList.add('text-emerald-400');
        }
        
        function stopBGM() {
            if (bgmLoop) {
                bgmLoop.stop();
                bgmLoop.dispose();
                bgmLoop = null;
            }
            Tone.Transport.stop();
            isBGMPlaying = false;
            document.getElementById('bgm-toggle').textContent = 'â™«';
            document.getElementById('bgm-toggle').classList.remove('text-emerald-400');
        }

        async function initializeAudio() {
            if (isAudioInitialized) return;
            try {
                await Tone.start();
                isAudioInitialized = true;
                startBGM();
            } catch (e) {
                console.error(e);
            }
        }
        
        // ----------------------------------------------------
        // 3. UI Helper
        // ----------------------------------------------------

        // UPDATED: Added definition parameter for dynamic content
        function displayModal(title, content, actionButtons = '') {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal" id="game-modal">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                            <h2 class="text-2xl font-bold text-white tracking-wide">${title}</h2>
                            <button class="bg-gray-700 hover:bg-gray-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition" onclick="document.getElementById('modal-container').innerHTML = ''">
                                âœ•
                            </button>
                        </div>
                        <div class="text-gray-300 leading-relaxed font-light space-y-4">
                            ${content}
                        </div>
                        ${actionButtons ? `<div class="mt-6 pt-4 border-t border-gray-700 flex justify-end">${actionButtons}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // NEW: Function to display glossary definition
        window.showGlossaryDefinition = (term) => {
            playClickSFX();
            const definition = gameState.glossary[term];
            if (definition) {
                displayModal(`ğŸ“š è¡“èªå®šç¾©: ${term}`, 
                    `<p class="text-lg text-yellow-300 font-bold mb-3">${term}</p>
                    <p>${parseText(definition)}</p>
                    <p class="text-xs text-gray-500 mt-4 italic">æ­¤è©å½™æºæ–¼è²¼æ–‡åˆ†ææˆ–æç¤ºè³‡è¨Šã€‚</p>`
                );
            } else {
                displayModal('éŒ¯èª¤', `<p>æ‰¾ä¸åˆ°è©å½™ ${term} çš„å®šç¾©ã€‚</p>`);
            }
        };


        function displayError(message) {
            if (errorState && errorMessageDetail) {
                errorState.classList.remove('hidden');
                errorMessageDetail.textContent = message;
                document.getElementById('game-content').classList.remove('hidden'); 
                Object.values(stages).forEach(el => el.classList.add('hidden'));
                playFailureSFX();
            }
        }
        
        function hideError() {
            if (errorState) errorState.classList.add('hidden');
        }

        function showScenario(show) {
            const container = document.getElementById('scenario-display-container');
            const content = document.getElementById('scenario-content-display');
            if (show && gameState.scenario) {
                // é¡¯ç¤ºåªæœ‰è²¼æ–‡å…§å®¹ï¼Œä¸åŒ…å«æ¨™é¡Œ
                const opContent = gameState.scenario.split('\n\n')[1] || gameState.scenario;
                content.innerHTML = parseText(opContent.replace(/\n/g, '<br>'));
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function showStage(stage) {
            // Hide prev
            const prev = stages[gameState.currentStage];
            if (prev) {
                prev.classList.add('hidden');
                prev.classList.remove('stage-transition');
            }

            // Show new
            const next = stages[stage];
            if (next) {
                next.classList.remove('hidden');
                setTimeout(() => next.classList.add('stage-transition'), 10);
            }

            gameState.currentStage = stage;
            const stageNames = {
                0: 'ä»»å‹™åˆå§‹åŒ–', 
                1: 'é‚è¼¯åˆ†æ', 
                2: 'è§’è‰²æ¨¡æ“¬', 
                3: 'æƒ…å ±è’é›†', 
                4: 'é­”ç‹æˆ°', 
                5: 'æœ€çµ‚çµç®—'
            };
            if(stageDisplay) stageDisplay.textContent = `ç•¶å‰éšæ®µï¼š${stageNames[stage]}`;

            // Show scenario for all stages > 0 (Persistent OP)
            showScenario(stage >= 1);
        }

        function toggleLoading(show, message = 'AI é‹ç®—ä¸­...') {
            if (loadingState && document.getElementById('game-content')) {
                loadingState.classList.toggle('hidden', !show);
                document.getElementById('game-content').classList.toggle('hidden', show); 
                loadingMessage.textContent = message;
            }
        }
        
        // ----------------------------------------------------
        // 4. API & Schemas
        // ----------------------------------------------------
        
        function createPayload(prompt, schema, isRandomCall = false) {
            const systemPrompt = isRandomCall 
                ? "è«‹ç”Ÿæˆè²¼è¿‘ Threads/Dcard é¢¨æ ¼çš„ä¸­æ–‡è²¼æ–‡ã€‚è«‹è¼¸å‡ºç´”æ–‡å­—ï¼Œä¸è¦ä½¿ç”¨markdownæ ¼å¼ã€‚"
                : "æ‚¨æ˜¯æ€ç¶­è¾¯è«–éŠæˆ²AIã€‚è«‹åš´æ ¼æŒ‰ç…§JSON Schemaè¼¸å‡ºç¹é«”ä¸­æ–‡ã€‚è§’è‰²è³‡è¨Šéœ€åŒ…å«emojièˆ‡ç«‹å ´å‹•æ©Ÿã€‚ä¸è¦ä½¿ç”¨markdownæ ¼å¼ã€‚";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }
            return payload;
        }
        
        const randomScenarioSchema = { type: "OBJECT", properties: { "postTitle": { "type": "STRING" }, "postContent": { "type": "STRING" } }, required: ["postTitle", "postContent"] };
        
        const gameSetupSchema = { 
            type: "OBJECT", 
            properties: { 
                "fojStatements": { 
                    "type": "ARRAY", 
                    "items": { 
                        "type": "OBJECT", 
                        "properties": {
                            // UPDATED: Removed "Judgment" from enum. Now only "Fact" or "Opinion"
                            "statement": { "type": "STRING" },
                            "correctAnswer": { "type": "STRING", "enum": ["Fact", "Opinion"] },
                            "explanation": { "type": "STRING" },
                            "term": { "type": "STRING", "description": "If the statement contains a complex or ambiguous noun/term, list it here for glossary. Otherwise, leave it empty." },
                            "termDefinition": { "type": "STRING", "description": "The concise definition of the term, if provided." } 
                        },
                        "required": ["statement", "correctAnswer", "explanation", "term", "termDefinition"] 
                    } 
                }, 
                "characters": { 
                    "type": "ARRAY", 
                    "items": { 
                        "type": "OBJECT", 
                        "properties": { 
                            "name": { "type": "STRING" }, 
                            "job": { "type": "STRING" }, 
                            "icon": { "type": "STRING" }, 
                            "stance": { "type": "STRING" }, 
                            "motivation": { "type": "STRING" }, 
                            "comment": { "type": "STRING" } 
                        }, 
                        "required": ["name", "job", "icon", "stance", "motivation", "comment"] 
                    } 
                } 
            }, 
            required: ["fojStatements", "characters"] 
        };
        
        const rolePlayCritiqueSchema = { type: "OBJECT", properties: { "score": { "type": "NUMBER" }, "critique": { "type": "STRING" } }, required: ["score", "critique"] };
        
        const trollCharacterSchema = { type: "OBJECT", properties: { 
            "name": { "type": "STRING" }, 
            "job": { "type": "STRING", "description": "The troll's precise job or status, e.g., å¾…æ¥­ã€å¤§å­¸ç”Ÿã€ç‰©æµå¸æ©Ÿã€äººè³‡åŠ©ç†" }, 
            "age": { "type": "NUMBER", "description": "The troll's age, use a random number between 18 and 50." },
            "icon": { "type": "STRING" }, 
            "stance": { "type": "STRING" }, 
            "initialComment": { "type": "STRING" },
            "fallacies": { "type": "ARRAY", "items": { "type": "STRING", "description": "List 3 common logical fallacies the troll might use, e.g., ç¨»è‰äººè¬¬èª¤, äººèº«æ”»æ“Š, è¨´è«¸æƒ…æ„Ÿ" } } 
        }, required: ["name", "job", "age", "icon", "stance", "initialComment", "fallacies"] };
        
        const bossResponseSchema = { type: "OBJECT", properties: { "bossResponse": { "type": "STRING" }, "statusMessage": { "type": "STRING" }, "moraleChange": { "type": "NUMBER", "description": "Negative integer (e.g., -20) if player argument is good/logical. Positive (e.g., +10) if player is irrational or weak." }, "logicalFallacy": { "type": "STRING", "description": "The specific logical fallacy used in this bossResponse, e.g., è¨´è«¸ç¾¤çœ¾" } }, required: ["bossResponse", "statusMessage", "moraleChange", "logicalFallacy"] };
        
        const evaluationSchema = { type: "OBJECT", properties: { "persuasionSuccess": { "type": "BOOLEAN" }, "finalBossVerdict": { "type": "STRING" }, "logicScore": { "type": "NUMBER" }, "debateCritique": { "type": "STRING" }, "debateSuggestions": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["persuasionSuccess", "finalBossVerdict", "logicScore", "debateCritique", "debateSuggestions"] };
        
        const hintSchema = { type: "OBJECT", properties: { 
            "hintText": { "type": "STRING" },
            "keyTerm": { "type": "STRING", "description": "A single key technical or ambiguous term that the player should pay attention to." },
            "termDefinition": { "type": "STRING", "description": "A brief explanation of the key term to aid the player's understanding." }
        }, required: ["hintText", "keyTerm", "termDefinition"] };

        // ----------------------------------------------------
        // 5. API Fetch
        // ----------------------------------------------------
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 403 || response.status === 401) throw new Error("API Key Error");
                    throw new Error(`Error: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }
        }

        async function apiCall(payload) {
            if (!apiKey || apiKey.trim() === '') throw new Error("API Key Missing");
            const response = await fetchWithRetry(GEMINI_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (jsonText) return JSON.parse(jsonText);
            throw new Error("No valid response from AI");
        }

        // ----------------------------------------------------
        // 6. Stage 0: Init
        // ----------------------------------------------------
        async function generateRandomScenario(category) {
            playClickSFX();
            hideError();
            toggleLoading(true, `AI æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆ æœ‰è¶£çš„ã€åè«·çš„ çˆ­è­°è©±é¡Œ...`);
            try {
                const prompt = `è«‹ç”Ÿæˆä¸€å€‹é—œæ–¼${category}çš„çˆ­è­°æ€§è²¼æ–‡(Threads/Dcardé¢¨æ ¼)ã€‚å…§å®¹éœ€å¸¶æœ‰æœ‰è¶£æˆ–åè«·çš„é¢¨æ ¼ã€‚150å­—å·¦å³ã€‚æä¾›æ¨™é¡Œå’Œå…§å®¹ã€‚`;
                const payload = createPayload(prompt, randomScenarioSchema, true);
                const aiResult = await apiCall(payload);
                gameState.scenario = `${aiResult.postTitle}\n\n${aiResult.postContent}`;
                gameState.scenarioCategory = category;
                document.getElementById('scenario-input').value = aiResult.postContent;
                toggleLoading(false);
            } catch (error) {
                toggleLoading(false);
                displayError(error.message);
            }
        }
        
        function renderStage0() {
            hideError(); 
            const html = `
                <div class="card p-8 rounded-3xl bg-gray-800/80">
                    <h2 class="text-3xl font-black text-emerald-400 mb-6 tracking-wide">é¸æ“‡æˆ°å ´è©±é¡Œ</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                        <button data-category="ä¸–ç•Œæ™‚äº‹" class="soft-btn py-5 text-lg shadow-lg">ğŸŒ ä¸–ç•Œæ™‚äº‹</button>
                        <button data-category="ç¤¾æœƒè­°é¡Œ" class="soft-btn py-5 text-lg shadow-lg" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color:white;">ğŸ—£ï¸ ç¤¾æœƒè­°é¡Œ</button>
                        <button data-category="ç”Ÿæ´»æ™‚äº‹" class="soft-btn py-5 text-lg shadow-lg" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white;">ğŸ¡ ç”Ÿæ´»æ™‚äº‹</button>
                        <button data-category="ç§‘æŠ€è¶¨å‹¢" class="soft-btn py-5 text-lg shadow-lg" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color:white;">ğŸ¤– ç§‘æŠ€è¶¨å‹¢</button>
                        <button data-category="å¨›æ¨‚å…«å¦" class="soft-btn py-5 text-lg shadow-lg" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:white;">ğŸ¿ å¨›æ¨‚å…«å¦</button>
                        <button data-category="éš¨æ©Ÿç”Ÿæˆ" class="soft-btn py-5 text-lg shadow-lg" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color:white;">ğŸ² éš¨æ©Ÿç”Ÿæˆ</button>
                    </div>

                    <div class="relative flex py-5 items-center">
                        <div class="flex-grow border-t border-gray-600"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-500 text-xs">æˆ–æ˜¯æ‰‹å‹•è¼¸å…¥è²¼æ–‡</span>
                        <div class="flex-grow border-t border-gray-600"></div>
                    </div>

                    <textarea id="scenario-input" rows="4" 
                              class="w-full p-5 bg-gray-900/50 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-emerald-500 transition shadow-inner"
                              placeholder="è²¼å…¥ Threads/Dcard æ–‡ç« å…§å®¹..."></textarea>
                    
                    <button id="start-button" class="mt-8 w-full soft-btn-secondary py-4 rounded-xl text-xl font-bold tracking-widest shadow-xl">
                        é–‹å§‹æŒ‘æˆ°
                    </button>
                </div>
            `;
            stages[0].innerHTML = html;

            stages[0].querySelectorAll('button[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    initializeAudio();
                    const cat = btn.getAttribute('data-category');
                    generateRandomScenario(cat === 'éš¨æ©Ÿç”Ÿæˆ' ? 'ç†±é–€è­°é¡Œ' : cat);
                });
            });

            document.getElementById('start-button').addEventListener('click', async () => {
                playClickSFX();
                initializeAudio();
                const scenario = document.getElementById('scenario-input').value.trim();
                if (!scenario) return displayError("è«‹è¼¸å…¥è²¼æ–‡å…§å®¹");
                
                gameState.scenario = scenario;
                gameState.scenarioCategory = gameState.scenarioCategory || "è‡ªè¡Œè¼¸å…¥";

                toggleLoading(true, `åˆ†æè²¼æ–‡æ¶æ§‹ã€åŠƒåˆ† F/O (äº‹å¯¦/è§€é») ä¸¦ç”Ÿæˆè§’è‰²ä¸­...`);
                try {
                    // UPDATED: Instruct AI to generate ONLY Fact/Opinion.
                    const prompt = `é‡å°è²¼æ–‡ï¼šã€Œ${gameState.scenario}ã€ã€‚ç”Ÿæˆ5å€‹é™³è¿°å¥ï¼Œä¸¦ç‚ºæ¯å€‹é™³è¿°å¥æä¾›å…¶æ­£ç¢ºçš„ F/O (äº‹å¯¦/è§€é») åˆ†é¡ã€è©³ç´°è§£é‡‹ï¼Œä»¥åŠå¦‚æœåŒ…å«è¤‡é›œè©å½™ï¼Œè«‹åœ¨ "term" æ¬„ä½æä¾›è©²è©å½™ä¸¦åœ¨ "termDefinition" æ¬„ä½æä¾›è©²è©å½™çš„ç°¡æ½”è§£é‡‹ã€‚è«‹**ä¸è¦**ä½¿ç”¨ã€Œåˆ¤æ–·(Judgment)ã€ä½œç‚ºåˆ†é¡çµæœã€‚åŒæ™‚ç”Ÿæˆ3å€‹ä¸åŒç«‹å ´çš„ç¤¾ç¾¤è§’è‰²ï¼Œæ¯å€‹è§’è‰²éœ€æœ‰åå­—ã€è·æ¥­ã€emoji iconã€ç«‹å ´ã€å…·é«”å‹•æ©Ÿ(motivation)èˆ‡åˆå§‹è©•è«–ã€‚ç¹é«”ä¸­æ–‡ã€‚`;
                    const payload = createPayload(prompt, gameSetupSchema);
                    gameState.gameData = await apiCall(payload); 
                    gameState.fojScore = 0; 
                    
                    // NEW: Populate glossary
                    gameState.glossary = {};
                    gameState.gameData.fojStatements.forEach(item => {
                        if (item.term && item.termDefinition) {
                            gameState.glossary[item.term] = item.termDefinition;
                        }
                    });

                    toggleLoading(false);
                    playSuccessSFX();
                    renderStage1();
                    showStage(1);
                } catch (error) {
                    toggleLoading(false);
                    displayError(error.message);
                }
            });
        }
        
        // ----------------------------------------------------
        // 7. Stage 1: F/O (Logic and Gameification)
        // ----------------------------------------------------
        function renderStage1() {
            const fojData = gameState.gameData.fojStatements;
            let html = `
                <div class="card p-6 mb-6 border-l-4 border-emerald-500">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-emerald-400">Phase 1: é‚è¼¯æ‹†è§£ (äº‹å¯¦/è§€é»)</h2>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs font-bold text-gray-400">ç•¶å‰å¾—åˆ†: </span>
                            <span id="foj-current-score" class="text-2xl font-black text-yellow-400">${gameState.fojScore}</span>
                            <button id="foj-info-button" class="text-xs bg-gray-700 px-3 py-1 rounded-full hover:bg-gray-600 text-white transition">ä»€éº¼æ˜¯ F/O?</button>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">è«‹åˆ¤æ–·ä»¥ä¸‹é™³è¿°æ˜¯ äº‹å¯¦(Fact) é‚„æ˜¯ è§€é»(Opinion)ã€‚</p>
                </div>
                <div id="statement-list" class="space-y-4">
            `;
            
            fojData.forEach((item, idx) => { 
                html += `
                    <div class="card p-5 flex flex-col md:flex-row justify-between items-center gap-4 foj-statement" data-index="${idx}" data-state="pending">
                        <p class="text-white flex-grow font-medium leading-relaxed"><span class="text-emerald-500 font-mono mr-3">0${idx+1}.</span>${parseText(item.statement)}</p>
                        <div class="flex space-x-2 shrink-0 foj-buttons">
                            <button data-type="Fact" class="tag-btn bg-gray-800 border border-emerald-600/30 text-emerald-400 hover:bg-emerald-600 hover:text-white py-2 px-4 rounded-lg text-xs font-bold transition">äº‹å¯¦</button>
                            <button data-type="Opinion" class="tag-btn bg-gray-800 border border-yellow-600/30 text-yellow-400 hover:bg-yellow-600 hover:text-white py-2 px-4 rounded-lg text-xs font-bold transition">è§€é»</button>
                        </div>
                        <p class="result-message hidden text-sm font-bold absolute right-5 top-5"></p>
                    </div>
                `;
            });

            html += `</div>
                <button id="stage1-next-button" class="mt-8 w-full soft-btn-secondary py-4 text-lg shadow-lg" disabled>
                    æäº¤ä¸¦æª¢è¦–çµæœ
                </button>
            `;
            stages[1].innerHTML = html;
            
            const userSelections = new Array(fojData.length).fill(null);
            const nextBtn = document.getElementById('stage1-next-button');
            const scoreDisplay = document.getElementById('foj-current-score');
            let completedCount = 0;

            document.getElementById('foj-info-button').addEventListener('click', () => {
                displayModal('F/O å®šç¾©', 
                    `<ul class="list-disc pl-5 space-y-2">
                        <li><strong class="text-emerald-400">äº‹å¯¦ (Fact)</strong>: å®¢è§€å­˜åœ¨ï¼Œå¯è¢«é©—è­‰çœŸå½ã€‚åˆ†æ•¸: +20</li>
                        <li><strong class="text-yellow-400">è§€é» (Opinion)</strong>: å€‹äººçš„æƒ³æ³•æˆ–æ„Ÿå—ï¼Œç„¡å°éŒ¯ä¹‹åˆ†ã€‚åˆ†æ•¸: +20</li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-500 italic">æ¯é¡Œç­”å°å¯ç²å¾— 20 åˆ†ã€‚ç¸½åˆ† 100 åˆ†å°‡ä½œç‚ºæœ€çµ‚é‚è¼¯åˆ†æ•¸çš„åŸºç¤ã€‚</p>`);
            });

            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const parent = e.target.closest('.foj-statement');
                    if (parent.getAttribute('data-state') !== 'pending') return; // Prevent re-selection
                    
                    playClickSFX();
                    const idx = parent.getAttribute('data-index');
                    const selectedType = e.target.getAttribute('data-type');
                    const correctType = fojData[idx].correctAnswer;
                    
                    userSelections[idx] = selectedType;
                    parent.setAttribute('data-state', 'selected');

                    // Disable buttons and check answer immediately (Gameification)
                    parent.querySelectorAll('.tag-btn').forEach(b => {
                        b.disabled = true;
                        b.classList.remove('bg-gray-100', 'text-gray-900', 'ring-2', 'ring-white');
                    });
                    
                    const messageEl = parent.querySelector('.result-message');
                    messageEl.classList.remove('hidden');

                    if (selectedType === correctType) {
                        playSuccessSFX();
                        parent.classList.add('border-emerald-500/50', 'bg-emerald-900/10');
                        messageEl.classList.add('text-emerald-400');
                        messageEl.textContent = 'âœ… æ­£ç¢º! (+20)';
                        gameState.fojScore += 20; // 5 questions * 20 = 100
                    } else {
                        playFailureSFX();
                        parent.classList.add('border-red-500/50', 'bg-red-900/10');
                        messageEl.classList.add('text-red-400');
                        messageEl.textContent = `âŒ éŒ¯èª¤. æ­£è§£: ${correctType}`;
                    }

                    scoreDisplay.textContent = gameState.fojScore;

                    // Highlight the correct button after selection
                    parent.querySelectorAll('.tag-btn').forEach(b => {
                        if (b.getAttribute('data-type') === correctType) {
                            b.classList.add('ring-2', 'ring-yellow-500'); // Highlight correct choice
                        }
                    });

                    completedCount++;
                    if (completedCount === fojData.length) {
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('soft-btn-secondary');
                        nextBtn.classList.add('soft-btn');
                    }
                });
            });

            nextBtn.addEventListener('click', async () => {
                playClickSFX();
                gameState.userFactChecks = userSelections;
                
                renderStage2();
                showStage(2);
            });
        }

        // ----------------------------------------------------
        // 8. Stage 2: Result & Role Play
        // ----------------------------------------------------
        function renderStage2() {
            const fojData = gameState.gameData.fojStatements;
            const statements = fojData.map(item => item.statement);
            
            // Randomly assign role
            const role = gameState.gameData.characters[gameState.assignedRoleIndex = Math.floor(Math.random()*3)];

            let html = `
                <div class="card p-6 mb-6 border-l-4 border-emerald-500">
                    <h2 class="text-xl font-bold text-emerald-400">Phase 2: åˆ†æçµæœèˆ‡è§’è‰²æ¨¡æ“¬</h2>
                    <div class="flex items-center space-x-4 mt-2">
                         <p class="text-gray-400 text-sm">é‚è¼¯æ‹†è§£å¾—åˆ†: </p>
                         <span class="text-3xl font-black text-yellow-400">${gameState.fojScore} / 100</span>
                    </div>
                </div>
                <div class="space-y-4 mb-10">
            `;
            
            statements.forEach((stmt, i) => {
                const correct = fojData[i].correctAnswer;
                const explanation = fojData[i].explanation;
                const isCorrect = gameState.userFactChecks[i] === correct;
                const color = isCorrect ? 'border-emerald-500/50' : 'border-red-500/50';
                const bg = isCorrect ? 'bg-emerald-900/10' : 'bg-red-900/10';
                
                const wrongBadge = !isCorrect ? `<span class="text-xs font-bold text-red-300 mr-2 strike-through">æ‚¨é¸: ${gameState.userFactChecks[i]}</span>` : '';

                html += `
                    <div class="card p-4 border-l-4 ${color} ${bg} rounded-r-xl">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-sm text-gray-200 font-medium">${parseText(stmt)}</p>
                            <span class="text-xs px-2 py-1 rounded-md ${isCorrect ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'} font-bold whitespace-nowrap ml-2">
                                ${isCorrect ? 'âœ…' : 'âŒ'}
                            </span>
                        </div>
                        <div class="text-xs text-gray-400 bg-gray-900/50 p-3 rounded-lg">
                            <p class="mb-1">${wrongBadge} <span class="text-emerald-400 font-bold">æ­£è§£: ${correct}</span></p>
                            <p>${parseText(explanation)}</p>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div id="role-play-area" class="card p-8 border-2 border-indigo-500/50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl">ğŸ­</div>
                    <h2 class="text-2xl font-bold text-indigo-400 mb-6">Role Assignment: è§’è‰²åˆ†æ´¾</h2>
                    
                    <div class="bg-indigo-900/20 p-6 rounded-2xl border border-indigo-500/30 flex flex-col md:flex-row items-center gap-6 mb-6">
                        <div class="text-7xl emoji-icon drop-shadow-xl filter">${role.icon}</div>
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-1">${role.name}</h3>
                            <p class="text-indigo-300 font-medium mb-3">${role.job} <span class="mx-2">|</span> ç«‹å ´ï¼š${role.stance}</p>
                            
                            <div class="bg-black/30 p-4 rounded-xl">
                                <p class="text-xs text-indigo-200 font-bold mb-1 uppercase tracking-wider">å‹•æ©Ÿ (Motivation):</p>
                                <p class="text-gray-300 text-sm italic leading-relaxed">"${parseText(role.motivation || 'ç„¡å‹•æ©Ÿè³‡æ–™')}"</p>
                            </div>
                        </div>
                    </div>

                    <p class="text-gray-300 mb-2 font-medium">ä»»å‹™ï¼šè«‹æ ¹æ“šè©²è§’è‰²çš„å‹•æ©Ÿèˆ‡ç«‹å ´ï¼Œæ’°å¯«ä¸€å‰‡ç•™è¨€ã€‚</p>
                    <textarea id="role-input" rows="4" class="w-full p-4 bg-gray-800 border border-indigo-500/50 rounded-xl text-white focus:border-indigo-400 transition" placeholder="è©¦è‘—æ¨¡ä»¿ ${role.name} çš„èªæ°£..."></textarea>
                    <button id="stage2-btn" class="mt-6 w-full soft-btn-secondary py-4 rounded-xl text-lg font-bold" disabled>æäº¤æ¨¡æ“¬ç•™è¨€</button>
                </div>
                <div id="critique-area"></div>
            `;
            stages[2].innerHTML = html;

            const input = document.getElementById('role-input');
            const btn = document.getElementById('stage2-btn');
            input.addEventListener('input', () => btn.disabled = input.value.length < 5);

            btn.addEventListener('click', async () => {
                playClickSFX();
                gameState.userRoleArgument = input.value;
                toggleLoading(true, 'AI å°å¸«è©•åˆ†ä¸­...');
                try {
                    const prompt = `è©•ä¼°è§’è‰²æ‰®æ¼”ï¼šè§’è‰²${role.name}(${role.job}, å‹•æ©Ÿ:${role.motivation})ï¼Œç©å®¶æ¨¡æ“¬è©•è«–ï¼š${input.value}ã€‚çµ¦åˆ†(0-100)èˆ‡å›é¥‹ã€‚`;
                    const res = await apiCall(createPayload(prompt, rolePlayCritiqueSchema));
                    gameState.rolePlayCritique = res;
                    
                    const scoreColor = res.score >= 80 ? 'text-emerald-400' : (res.score >= 60 ? 'text-yellow-400' : 'text-red-400');
                    document.getElementById('role-play-area').classList.add('hidden');
                    document.getElementById('critique-area').innerHTML = `
                        <div class="card p-8 border-t-4 border-indigo-500">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-2xl font-bold text-white">å°å¸«å›é¥‹</h3>
                                <div class="text-center">
                                    <span class="text-4xl font-black ${scoreColor}">${res.score}</span>
                                    <span class="text-sm text-gray-500 block">åˆ†</span>
                                </div>
                            </div>
                            <div class="bg-gray-800/50 p-6 rounded-2xl mb-6">
                                <p class="text-gray-300 leading-relaxed">${parseText(res.critique)}</p>
                            </div>
                            <button id="to-stage3" class="w-full soft-btn py-4 text-lg">å‰å¾€ä¸‹ä¸€éšæ®µ</button>
                        </div>
                    `;
                    document.getElementById('to-stage3').addEventListener('click', () => {
                        renderStage3(); showStage(3);
                    });
                    toggleLoading(false);
                    playSuccessSFX();
                } catch (e) {
                    toggleLoading(false);
                    displayError(e.message);
                }
            });
        }

        // ----------------------------------------------------
        // 9. Stage 3: Observation
        // ----------------------------------------------------
        function renderStage3() {
            const characters = gameState.gameData.characters;
            // Use glossary keys for display
            const glossaryTerms = Object.keys(gameState.glossary);

            let html = `
                <div class="card p-6 mb-6 border-l-4 border-emerald-500">
                    <h2 class="text-xl font-bold text-emerald-400">Phase 3: è¼¿è«–è§€å¯Ÿ (æƒ…å ±è’é›†)</h2>
                    <p class="text-gray-400 text-sm mt-1">çŸ¥å·±çŸ¥å½¼ã€‚è§€å¯Ÿç¤¾ç¾¤ä¸Šä¸åŒç«‹å ´çš„è²éŸ³ä¸¦ç†Ÿæ‚‰è¡“èªã€‚</p>
                </div>

                <!-- Glossary Section -->
                ${glossaryTerms.length > 0 ? `
                <div class="card p-5 mb-6 bg-yellow-900/20 border-yellow-500/50">
                    <h3 class="text-lg font-bold text-yellow-400 mb-3 flex items-center">
                        <span class="mr-2">ğŸ“š</span> å°ˆæœ‰åè© / é—œéµè¡“èª
                    </h3>
                    <div id="glossary-list-stage3" class="flex flex-wrap gap-2">
                        ${glossaryTerms.map(term => `<span class="glossary-term bg-yellow-800/50 text-yellow-300 text-xs px-3 py-1 rounded-full border border-yellow-700" onclick="showGlossaryDefinition('${term.replace(/'/g, "\\'")}')">${term}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            `;
            characters.forEach((char, i) => { 
                html += `
                    <div class="card p-5 character-enter hover:-translate-y-1 transition-transform" style="animation-delay: ${i*0.1}s">
                        <div class="flex items-center mb-4">
                            <span class="text-4xl mr-3 emoji-icon">${char.icon}</span>
                            <div>
                                <h3 class="font-bold text-white leading-tight">${char.name}</h3>
                                <p class="text-xs text-emerald-400 font-mono">${char.job}</p>
                            </div>
                        </div>
                        <div class="bg-gray-700/30 p-4 rounded-xl rounded-tl-none text-sm text-gray-200 dialog-bubble leading-relaxed" style="animation-delay: ${0.5+i*0.1}s">
                            "${parseText(char.comment)}"
                        </div>
                    </div>
                `;
            });
            html += `</div>
                <button id="to-stage4-setup" class="mt-10 w-full soft-btn-danger py-5 text-xl font-black tracking-widest shadow-xl">
                    âš ï¸ é€²å…¥æˆ°é¬¥æº–å‚™ (BATTLE SETUP)
                </button>
            `;
            stages[3].innerHTML = html;
            document.getElementById('to-stage4-setup').addEventListener('click', () => {
                playClickSFX();
                renderStage4Setup();
                showStage(4);
            });
        }

        // ----------------------------------------------------
        // 10. Stage 4: Boss Battle (Setup & Battle)
        // ----------------------------------------------------
        async function getHint(bossTxt, userTxt, bossFallacies) {
            const prompt = `
                æƒ…å¢ƒï¼š${gameState.scenario}
                é…¸æ°‘è«–é»ï¼š${bossTxt}
                é…¸æ°‘å¯èƒ½çš„é‚è¼¯è¬¬èª¤æ¸…å–®: ${bossFallacies.join(', ')}
                ç©å®¶å›°å¢ƒï¼šä¸çŸ¥é“å¦‚ä½•åé§ã€‚
                è«‹çµ¦å‡ºä¸€å€‹ç°¡çŸ­çš„ã€Œé‚è¼¯åé§æç¤ºã€ï¼ˆä¸è¦ç›´æ¥çµ¦ç­”æ¡ˆï¼ŒæŒ‡å‡ºå°æ–¹é‚è¼¯è¬¬èª¤æ–¹å‘æˆ–å¯ç”¨çš„äº‹å¯¦ï¼‰ã€‚åŒæ™‚ï¼Œå¦‚æœæç¤ºä¸­åŒ…å«é—œéµè¡“èªæˆ–æ¦‚å¿µï¼Œè«‹åœ¨ keyTerm å’Œ termDefinition ä¸­è¿”å›å…¶åç¨±å’Œè§£é‡‹ã€‚
            `;
            const payload = createPayload(prompt, hintSchema);
            return await apiCall(payload);
        }

        async function renderStage4Setup() {
            toggleLoading(true, 'æ­£åœ¨åˆ†æé…¸æ°‘æˆ°åŠ›...');
            gameState.debateHistory = [];
            gameState.bossMorale = 100;
            gameState.isSurrender = false;
            gameState.difficulty = 'MEDIUM'; // Reset to default

            try {
                const op = gameState.scenario.split('\n\n')[1] || gameState.scenario;
                const prompt = `é‡å°ã€Œ${op}ã€ç”Ÿæˆä¸€å€‹ã€Œæ²’çœ‹å…§æ–‡å°±é–‹å™´ã€çš„é…¸æ°‘ã€‚è«‹ç‚ºä»–æŒ‡å®šä¸€å€‹ç¢ºåˆ‡çš„è·æ¥­ï¼ˆä¾‹å¦‚ï¼šå¾…æ¥­ã€å¤§å­¸ç”Ÿã€ç‰©æµå¸æ©Ÿã€äººè³‡åŠ©ç†ç­‰ï¼‰å’Œå¹´é½¡ï¼ˆ18-50æ­²ï¼‰ã€‚ä¸¦æä¾›3ç¨®ä»–å¸¸ç”¨çš„é‚è¼¯è¬¬èª¤æ¸…å–®ã€‚ç¹é«”ä¸­æ–‡ã€‚`;
                const boss = await apiCall(createPayload(prompt, trollCharacterSchema));
                gameState.bossCharacter = boss;

                // Render Setup UI
                let html = `
                    <div class="card p-8 border-2 border-red-500 rounded-3xl text-center">
                        <h2 class="text-3xl font-black text-red-500 mb-2 tracking-widest uppercase">âš ï¸ WARNING: BOSS DETECTED</h2>
                        <div class="flex justify-center my-6">
                            <div class="text-9xl emoji-icon animate-pulse">${boss.icon}</div>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-1">${boss.name}</h3>
                        <p class="text-red-400 font-mono mb-6">${boss.job} (${boss.age}æ­²) | ${boss.stance}</p>
                        
                        <div class="bg-red-900/20 p-6 rounded-2xl mb-8 border border-red-500/30 text-left">
                            <p class="text-sm text-red-300 font-bold mb-2">é…¸æ°‘æ”»æ“Šé å‘Šï¼š</p>
                            <p class="text-gray-200 italic">"${parseText(boss.initialComment)}..."</p>
                            <p class="text-xs text-red-400 mt-4 border-t border-red-700/50 pt-2">å¸¸è¦‹è¬¬èª¤ï¼š${boss.fallacies.join('ã€')}</p>
                        </div>

                        <h4 class="text-xl font-bold text-white mb-4 border-t border-gray-700 pt-6">é¸æ“‡å°æˆ°é›£åº¦ (Difficulty)</h4>
                        <div class="grid grid-cols-3 gap-4 mb-6" id="difficulty-selector">
                            <!-- Easy -->
                            <button data-difficulty="EASY" class="soft-btn-difficulty py-5 rounded-xl transition-all hover:border-emerald-500">
                                <div class="text-3xl mb-1">${DIFFICULTY_SETTINGS.EASY.icon}</div>
                                <h5 class="text-lg font-bold text-emerald-400">${DIFFICULTY_SETTINGS.EASY.name}</h5>
                                <p class="text-xs text-gray-400">${DIFFICULTY_SETTINGS.EASY.description}</p>
                            </button>
                            <!-- Medium -->
                            <button data-difficulty="MEDIUM" class="soft-btn-difficulty py-5 rounded-xl transition-all selected">
                                <div class="text-3xl mb-1">${DIFFICULTY_SETTINGS.MEDIUM.icon}</div>
                                <h5 class="text-lg font-bold text-indigo-400">${DIFFICULTY_SETTINGS.MEDIUM.name}</h5>
                                <p class="text-xs text-gray-400">${DIFFICULTY_SETTINGS.MEDIUM.description}</p>
                            </button>
                            <!-- Hard -->
                            <button data-difficulty="HARD" class="soft-btn-difficulty py-5 rounded-xl transition-all hover:border-red-500">
                                <div class="text-3xl mb-1">${DIFFICULTY_SETTINGS.HARD.icon}</div>
                                <h5 class="text-lg font-bold text-red-400">${DIFFICULTY_SETTINGS.HARD.name}</h5>
                                <p class="text-xs text-gray-400">${DIFFICULTY_SETTINGS.HARD.description}</p>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <button id="mode-rounds" data-mode="rounds" class="group relative bg-gray-800 hover:bg-blue-900/40 border border-gray-600 hover:border-blue-500 p-6 rounded-2xl transition-all ring-2 ring-blue-500 bg-blue-900/20">
                                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">â±ï¸</div>
                                <h4 class="text-xl font-bold text-white mb-1">æˆ°è¡“å›åˆ (Tactical)</h4>
                                <div class="flex items-center justify-center mt-2 space-x-2">
                                    <span class="text-sm text-gray-400">å›åˆæ•¸:</span>
                                    <input type="number" id="round-input" value="4" min="1" max="10" class="w-16 bg-black/30 border border-gray-500 rounded text-center text-white" onclick="event.stopPropagation()">
                                </div>
                                <div id="check-rounds" class="absolute top-4 right-4 text-green-400 text-xl">âœ”</div>
                            </button>
                            <button id="mode-endless" data-mode="endless" class="group relative bg-gray-800 hover:bg-red-900/40 border border-gray-600 hover:border-red-500 p-6 rounded-2xl transition-all">
                                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">ğŸ’€</div>
                                <h4 class="text-xl font-bold text-white mb-1">ç„¡ç›¡æ­»é¬¥ (Endless)</h4>
                                <p class="text-sm text-gray-400">ç›´åˆ°é…¸æ°‘å£«æ°£æ­¸é›¶ç‚ºæ­¢ã€‚</p>
                                <div id="check-endless" class="absolute top-4 right-4 text-green-400 hidden text-xl">âœ”</div>
                            </button>
                        </div>

                        <button id="start-battle" class="w-full soft-btn-danger py-5 text-xl font-black tracking-widest shadow-2xl">
                            FIGHT! é–‹å§‹å°å³™
                        </button>
                    </div>
                `;
                stages[4].innerHTML = html;
                toggleLoading(false);

                // --- Mode Selection Logic ---
                let selectedMode = 'rounds';
                const btnEndless = document.getElementById('mode-endless');
                const btnRounds = document.getElementById('mode-rounds');
                const checkEndless = document.getElementById('check-endless');
                const checkRounds = document.getElementById('check-rounds');
                const roundInput = document.getElementById('round-input');

                function selectMode(mode) {
                    selectedMode = mode;
                    if (mode === 'endless') {
                        btnEndless.classList.add('ring-2', 'ring-red-500', 'bg-red-900/20');
                        btnRounds.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-900/20');
                        checkEndless.classList.remove('hidden');
                        checkRounds.classList.add('hidden');
                        roundInput.disabled = true;
                        roundInput.classList.add('opacity-50');
                    } else {
                        btnRounds.classList.add('ring-2', 'ring-blue-500', 'bg-blue-900/20');
                        btnEndless.classList.remove('ring-2', 'ring-red-500', 'bg-red-900/20');
                        checkRounds.classList.remove('hidden');
                        checkEndless.classList.add('hidden');
                        roundInput.disabled = false;
                        roundInput.classList.remove('opacity-50');
                    }
                }

                btnEndless.addEventListener('click', () => selectMode('endless'));
                btnRounds.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') selectMode('rounds');
                });
                roundInput.addEventListener('focus', () => selectMode('rounds'));
                
                // --- Difficulty Selection Logic ---
                const diffButtons = document.querySelectorAll('#difficulty-selector button');
                diffButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const difficultyKey = btn.getAttribute('data-difficulty');
                        gameState.difficulty = difficultyKey;
                        diffButtons.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        playClickSFX();
                    });
                });

                document.getElementById('start-battle').addEventListener('click', () => {
                    playClickSFX();
                    gameState.gameMode = selectedMode;
                    if (selectedMode === 'rounds') {
                        MAX_DEBATE_ROUNDS = parseInt(roundInput.value) || 4;
                    } else {
                        MAX_DEBATE_ROUNDS = 999; // Effectively infinite
                    }
                    renderStage4Battle();
                });

            } catch (e) {
                toggleLoading(false);
                displayError(e.message);
            }
        }

        function renderStage4Battle() {
            const boss = gameState.bossCharacter;
            const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
            
            let html = `
                <div class="card p-6 mb-6 border-red-500/50 bg-red-900/5 flex justify-between items-center rounded-2xl">
                    <div>
                        <h2 class="text-2xl font-black text-red-400 tracking-wide">Phase 4: æœ€çµ‚éµç›¤æˆ°</h2>
                        <p class="text-red-300/70 text-sm">é›£åº¦: ${difficulty.name} | ${gameState.gameMode === 'endless' ? '(ç„¡ç›¡æ¨¡å¼: å£«æ°£æ­¸é›¶ç²å‹)' : `(å›åˆæ¨¡å¼: ${MAX_DEBATE_ROUNDS}å›åˆ)`}</p>
                    </div>
                    <div class="text-right w-1/3">
                        <p class="text-xs text-red-400 font-bold mb-1 uppercase">Boss Morale (å£«æ°£)</p>
                        <div class="w-full h-3 bg-gray-700 rounded-full overflow-hidden relative">
                            <div id="boss-morale-bar-fill" class="h-full bg-red-500 w-full transition-all duration-500"></div>
                        </div>
                        <p id="morale-value" class="text-xs text-red-300 mt-1 font-mono">100%</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-6 h-[500px]">
                    <!-- Boss Profile & Logic Notes (Updated) -->
                    <div class="md:w-1/3 flex flex-col space-y-4">
                        <div class="card p-6 text-center border-t-4 border-red-500 h-fit">
                            <div class="text-8xl mb-4 emoji-icon animate-bounce-slow">${boss.icon}</div>
                            <h3 class="text-2xl font-bold text-white">${boss.name}</h3>
                            <p class="text-red-400 font-medium text-sm mb-4">${boss.job} (${boss.age}æ­²) | ${boss.stance}</p>
                        </div>
                        
                        <!-- NEW: Logic Notes/Glossary Section -->
                        <div class="card p-4 flex-grow border-t-4 border-yellow-500 overflow-y-auto bg-gray-800/50">
                            <h4 class="text-lg font-bold text-yellow-400 mb-3 flex items-center border-b border-gray-700 pb-2">
                                <span class="mr-2">ğŸ“</span> é‚è¼¯ç­†è¨˜èˆ‡ç´€éŒ„
                            </h4>
                            <div id="logic-notes" class="space-y-3 text-sm text-gray-300">
                                <p class="text-xs text-gray-500 italic">--- è¬¬èª¤ç´€éŒ„ ---</p>
                                <div id="fallacy-log" class="space-y-1">
                                    <!-- Fallacies will be logged here -->
                                </div>
                                <p class="text-xs text-gray-500 italic pt-2 border-t border-gray-700">--- å°ˆæœ‰åè© ---</p>
                                <div id="glossary-display" class="flex flex-wrap gap-2">
                                    <!-- UPDATED: Added click handler for terms -->
                                    ${Object.keys(gameState.glossary).map(term => 
                                        `<span id="term-${term}" class="glossary-term bg-yellow-800/50 text-yellow-300 text-xs px-3 py-1 rounded-full border border-yellow-700" onclick="showGlossaryDefinition('${term.replace(/'/g, "\\'")}')">${term}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Log & Input -->
                    <div class="md:w-2/3 flex flex-col h-full">
                        <div id="debate-log" class="flex-grow bg-black/20 border border-gray-700/50 p-5 rounded-2xl overflow-y-auto mb-4 space-y-4 scroll-smooth">
                            <!-- Logs -->
                        </div>
                        
                        <div class="relative shrink-0">
                            <textarea id="debate-input" rows="3" class="w-full p-4 bg-gray-800 border border-gray-600 rounded-xl text-white focus:border-indigo-500 transition shadow-inner" placeholder="ç”¨äº‹å¯¦èˆ‡é‚è¼¯åæ“Š..."></textarea>
                            
                            <div class="flex gap-3 mt-3">
                                <button id="surrender-btn" class="px-4 py-3 rounded-xl font-bold text-sm bg-gray-700 text-gray-300 hover:bg-gray-600 border border-gray-500 transition whitespace-nowrap">
                                    ğŸ³ï¸ æˆ‘æ”¾æ£„
                                </button>
                                <button id="hint-btn" class="flex-1 py-3 rounded-xl font-bold text-sm bg-yellow-600/20 text-yellow-400 hover:bg-yellow-600/30 border border-yellow-600/50 transition">
                                    ğŸ’¡ ç´¢å–æç¤º
                                </button>
                                <button id="send-btn" class="flex-[2] soft-btn-secondary py-3 rounded-xl font-bold tracking-widest disabled:opacity-50">
                                    ç™¼é€åæ“Š
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            stages[4].innerHTML = html;

            gameState.debateHistory.push({speaker:'Boss', text:boss.initialComment});
            addLog('Boss', boss.initialComment, boss.icon);
            
            const sendBtn = document.getElementById('send-btn');
            const hintBtn = document.getElementById('hint-btn');
            const surrenderBtn = document.getElementById('surrender-btn');
            const input = document.getElementById('debate-input');
            const moraleBar = document.getElementById('boss-morale-bar-fill');
            const moraleVal = document.getElementById('morale-value');
            
            let currentRound = 1;
            const fallacyLog = document.getElementById('fallacy-log');
            const glossaryDisplay = document.getElementById('glossary-display');
            let loggedFallacies = []; // Track fallacies to avoid duplicates

            surrenderBtn.addEventListener('click', async () => {
                // IMPORTANT: Use custom modal instead of confirm()
                displayModal('ç¢ºèªæŠ•é™', 
                    `<p>ç¢ºå®šè¦æ”¾æ£„è¾¯è«–å—ï¼Ÿ</p><p class="text-red-400 font-bold">ä¸€æ—¦æŠ•é™ï¼Œé…¸æ°‘å°‡æœƒå®£ç¨±å‹åˆ©ï¼Œä¸¦åš´é‡å½±éŸ¿æ‚¨çš„æœ€çµ‚è©•åˆ†ã€‚</p>`,
                    `
                    <button class="soft-btn-danger px-4 py-2 rounded-lg" onclick="
                        gameState.isSurrender = true; 
                        document.getElementById('modal-container').innerHTML = ''; 
                        finishBattle();
                    ">ç¢ºå®šæ”¾æ£„</button>
                    <button class="bg-gray-600 text-white px-4 py-2 rounded-lg ml-3" onclick="document.getElementById('modal-container').innerHTML = ''">å–æ¶ˆ</button>
                    `
                );
            });

            hintBtn.addEventListener('click', async () => {
                playClickSFX();
                if (input.disabled) return;
                hintBtn.disabled = true;
                hintBtn.innerHTML = '<span class="animate-pulse">åˆ†æå¼±é»ä¸­...</span>';
                try {
                    const lastBossArg = gameState.debateHistory.filter(h => h.speaker === 'Boss').pop().text;
                    const hintRes = await getHint(lastBossArg, input.value, boss.fallacies);
                    
                    // NEW: Integrate key term from hint into glossary
                    if (hintRes.keyTerm && hintRes.termDefinition) {
                        const term = hintRes.keyTerm;
                        const definition = hintRes.termDefinition;
                        
                        // Add to global glossary state (only if new or definition updated)
                        if (gameState.glossary[term] !== definition) {
                            gameState.glossary[term] = definition;
                            // Update UI dynamically
                            if (!document.getElementById(`term-${term}`)) {
                                const termHtml = `<span id="term-${term}" class="glossary-term bg-yellow-800/50 text-yellow-300 text-xs px-3 py-1 rounded-full border border-yellow-700" onclick="showGlossaryDefinition('${term.replace(/'/g, "\\'")}')">${term}</span>`;
                                glossaryDisplay.innerHTML += termHtml;
                            }
                        }
                    }

                    // Display hint modal
                    displayModal('æˆ°è¡“æç¤º', `<p class="text-yellow-400 text-lg mb-2 font-bold">å»ºè­°åˆ‡å…¥é»ï¼š</p><p>${hintRes.hintText}</p>`);

                } catch(e) { 
                    console.error(e); 
                    displayModal('æç¤ºå¤±æ•—', `<p class="text-red-400">ç„¡æ³•å–å¾—æç¤ºã€‚AI é€£ç·šå¯èƒ½ä¸­æ–·ã€‚</p>`);
                } finally {
                    // FIX: Re-enable hint button
                    hintBtn.disabled = false;
                    hintBtn.innerHTML = 'ğŸ’¡ ç´¢å–æç¤º';
                }
            });

            sendBtn.addEventListener('click', async () => {
                playClickSFX();
                const txt = input.value.trim();
                if (txt.length < 5) return;
                
                input.value = '';
                input.disabled = true;
                sendBtn.disabled = true;
                hintBtn.disabled = true;
                surrenderBtn.disabled = true;

                addLog('User', txt, 'ğŸ‘¤');
                gameState.debateHistory.push({speaker:'User', text:txt});

                // Check Rounds Limit Logic (Before fetching boss response)
                if (gameState.gameMode === 'rounds' && currentRound >= MAX_DEBATE_ROUNDS) {
                     finishBattle();
                     return;
                }

                // Boss Reply & Morale Update
                const prompt = `é…¸æ°‘å›æ‡‰ï¼š${JSON.stringify(gameState.debateHistory)}ã€‚ç©å®¶æœ€æ–°ï¼š${txt}ã€‚å …æŒèª¤è®€ï¼Œæƒ…ç·’åŒ–ã€‚è«‹æ ¹æ“šç©å®¶åé§çš„æœ‰æ•ˆæ€§çµ¦äºˆ moraleChange (è² æ•¸ä»£è¡¨é…¸æ°‘å—å‚·ï¼Œæ­£æ•¸ä»£è¡¨é…¸æ°‘å¾—æ„)ã€‚åŒæ™‚ï¼Œè«‹æŒ‡æ˜é…¸æ°‘æœ¬æ¬¡å›æ‡‰ä¸­ä½¿ç”¨çš„ã€Œé‚è¼¯è¬¬èª¤ã€åç¨±ï¼Œä¾‹å¦‚: ç¨»è‰äººè¬¬èª¤ã€‚`;
                try {
                    const bossRes = await apiCall(createPayload(prompt, bossResponseSchema));
                    
                    // Apply difficulty multiplier to morale change
                    const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
                    let change = bossRes.moraleChange || -10; 
                    
                    // If change is negative (player hits boss), reduce change value by multiplier (harder boss has more resistance)
                    if (change < 0) {
                        change = Math.round(change / difficulty.moraleMultiplier); 
                    } else {
                        // If change is positive (boss hits player), increase change value (harder boss hits harder)
                        change = Math.round(change * difficulty.moraleMultiplier); 
                    }

                    gameState.bossMorale = Math.max(0, Math.min(100, gameState.bossMorale + change));
                    
                    playBossResponseSFX();
                    addLog('Boss', bossRes.bossResponse, boss.icon, bossRes.statusMessage);
                    gameState.debateHistory.push({speaker:'Boss', text:bossRes.bossResponse, fallacy: bossRes.logicalFallacy, moraleChange: change});
                    
                    // Log Fallacy (Gameification)
                    if (bossRes.logicalFallacy && !loggedFallacies.includes(bossRes.logicalFallacy)) {
                        loggedFallacies.push(bossRes.logicalFallacy);
                        fallacyLog.innerHTML += `
                            <div class="flex items-start text-xs text-red-300">
                                <span class="text-red-500 mr-2 shrink-0 mt-1">ğŸš¨</span> 
                                <span class="font-bold">${bossRes.logicalFallacy}:</span> ${boss.name} åˆçŠ¯éŒ¯äº†!
                            </div>
                        `;
                        fallacyLog.scrollTop = fallacyLog.scrollHeight;
                    }


                    // UI Update
                    moraleBar.style.width = `${gameState.bossMorale}%`;
                    moraleVal.textContent = `${gameState.bossMorale}%`;
                    
                    // Flash effect based on change
                    const moraleContainer = document.getElementById('boss-morale-bar-fill').parentElement;
                    if(change < 0) {
                        moraleContainer.classList.add('ring-2', 'ring-green-400');
                        setTimeout(() => moraleContainer.classList.remove('ring-2', 'ring-green-400'), 500);
                    } else {
                        moraleContainer.classList.add('ring-2', 'ring-red-600');
                        setTimeout(() => moraleContainer.classList.remove('ring-2', 'ring-red-600'), 500);
                    }

                    // Check Win Condition (Endless or accidental KO in rounds)
                    if (gameState.bossMorale <= 0) {
                        setTimeout(finishBattle, 1000);
                        return;
                    }

                    currentRound++;
                } catch(e) {
                    displayError(e.message);
                } finally {
                    // FIX: Re-enable buttons after API call completes
                    input.disabled = false;
                    sendBtn.disabled = false;
                    hintBtn.disabled = false;
                    surrenderBtn.disabled = false;
                }
            });
        }

        async function finishBattle() {
            toggleLoading(true, 'è£åˆ¤æœ€çµ‚åˆ¤æ±ºä¸­...');
            
            const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
            let context = `ç©å®¶æ˜¯å¦æŠ•é™: ${gameState.isSurrender}ã€‚é…¸æ°‘å‰©é¤˜å£«æ°£: ${gameState.bossMorale}ã€‚éŠæˆ²æ¨¡å¼: ${gameState.gameMode}ã€‚ç©å®¶ F/O/J éšæ®µå¾—åˆ†: ${gameState.fojScore}ã€‚`;
            let isRoundWin = false;
            
            // Check for Round Mode Win Condition
            if (gameState.gameMode === 'rounds' && gameState.bossMorale > 0) {
                const totalMoraleLost = 100 - gameState.bossMorale;
                const requiredMoraleLoss = 100 * difficulty.winThreshold;
                if (totalMoraleLost >= requiredMoraleLoss) {
                    isRoundWin = true;
                    context += ` ç©å®¶åœ¨å›åˆæ¨¡å¼ä¸­æˆåŠŸå‰Šå¼± ${totalMoraleLost}% å£«æ°£ï¼Œé”åˆ°é–€æª» ${requiredMoraleLoss}%ï¼Œåˆ¤å®šç‚ºæˆ°è¡“æ€§å‹åˆ©ã€‚`;
                } else {
                    context += ` ç©å®¶åœ¨å›åˆæ¨¡å¼ä¸­åƒ…å‰Šå¼± ${totalMoraleLost}% å£«æ°£ï¼Œæœªé”é–€æª» ${requiredMoraleLoss}%ï¼Œåˆ¤å®šç‚ºå¤±æ•—ã€‚`;
                }
            }


            if (gameState.isSurrender) context += " ç©å®¶ä¸»å‹•æ”¾æ£„ï¼Œé…¸æ°‘ç²å¾—å‹åˆ©ã€‚";
            else if (gameState.bossMorale <= 0) context += " é…¸æ°‘å£«æ°£å´©æ½°ï¼Œç©å®¶ç²å¾—å£“å€’æ€§å‹åˆ©ã€‚";
            else if (isRoundWin) context += " ç©å®¶ç²å¾—æˆ°è¡“æ€§å‹åˆ©ã€‚";
            
            const prompt = `è©•å¯©è¾¯è«–æ­·å²ï¼š${JSON.stringify(gameState.debateHistory)}ã€‚æƒ…å¢ƒèƒŒæ™¯ï¼š${context}ã€‚è«‹é‡å°ç©å®¶è¡¨ç¾ï¼Œæä¾›3å€‹å…·é«”çš„ã€Œè¾¯è«–å„ªåŒ–å»ºè­°ã€(debateSuggestions)ã€‚**é‡è¦ï¼šæœ€çµ‚é‚è¼¯åˆ†æ•¸(logicScore)å¿…é ˆç¶œåˆè€ƒæ…®ç©å®¶åœ¨ F/O éšæ®µçš„å¾—åˆ†(max 100)èˆ‡é­”ç‹æˆ°çš„è¡¨ç¾(å£«æ°£æ‰£æ¸›å¤šå¯¡)ä¾†è¨ˆç®—ï¼Œä½¿é”æˆå‹åˆ©æ¢ä»¶çš„ç©å®¶èƒ½ç²å¾—æ›´é«˜çš„åˆ†æ•¸ (ä¾‹å¦‚: > 80)ã€‚**`;
            try {
                const evalRes = await apiCall(createPayload(prompt, evaluationSchema));
                gameState.evaluation = evalRes;
                renderStage5(); 
                showStage(5);
            } catch(e) {
                displayError(e.message);
            } finally {
                toggleLoading(false);
            }
        }

        function addLog(speaker, text, icon, status) {
            const log = document.getElementById('debate-log');
            const isUser = speaker === 'User';
            const parsedText = parseText(text);
            
            const html = `
                <div class="flex ${isUser ? 'justify-end log-entry-user' : 'justify-start log-entry-boss'}">
                    <div class="${isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'} p-4 rounded-2xl max-w-[85%] shadow-md relative group">
                        <div class="absolute -top-3 ${isUser ? '-right-2' : '-left-2'} text-2xl drop-shadow-md group-hover:scale-110 transition-transform">${icon}</div>
                        <p class="text-sm leading-relaxed">${parsedText}</p>
                        ${status ? `<p class="text-xs text-yellow-500/80 mt-2 font-mono border-t border-white/10 pt-1">STATUS: ${status}</p>` : ''}
                    </div>
                </div>
            `;
            log.innerHTML += html;
            log.scrollTop = log.scrollHeight;
        }

        // ----------------------------------------------------
        // 11. Stage 5: Evaluation
        // ----------------------------------------------------
        function renderStage5() {
            const { persuasionSuccess, finalBossVerdict, logicScore, debateCritique, debateSuggestions } = gameState.evaluation;
            const boss = gameState.bossCharacter;
            
            // Re-calculate success based on logic
            const difficulty = DIFFICULTY_SETTINGS[gameState.difficulty];
            let realSuccess = (gameState.bossMorale <= 0); // KO win
            
            if (gameState.gameMode === 'rounds' && gameState.bossMorale > 0) {
                const totalMoraleLost = 100 - gameState.bossMorale;
                const requiredMoraleLoss = 100 * difficulty.winThreshold;
                if (totalMoraleLost >= requiredMoraleLoss) {
                    realSuccess = true; // Tactical win
                }
            }
            
            // Final decision
            const realFail = gameState.isSurrender || (!realSuccess);

            if(!realFail) playSuccessSFX(); else playFailureSFX();

            let resultTitle = realFail ? 'æŒ‘æˆ°å¤±æ•—' : 'è¾¯è«–å‹åˆ©ï¼';
            if (gameState.isSurrender) resultTitle = 'æˆ°è¡“æ’¤é€€ (æŠ•é™)';
            let resultIcon = realFail ? 'ğŸ’€' : 'ğŸ†';

            let html = `
                <div class="card p-10 text-center border-t-8 ${!realFail ? 'border-emerald-500' : 'border-red-500'}">
                    <div class="mb-6">
                        <span class="text-6xl filter drop-shadow-xl">${resultIcon}</span>
                    </div>
                    <h1 class="text-4xl font-black mb-2 ${!realFail ? 'text-emerald-400' : 'text-red-500'} tracking-tight">
                        ${resultTitle}
                    </h1>
                    <p class="text-gray-400 font-medium tracking-widest mb-10 uppercase">Final Evaluation Report</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div class="bg-gray-800/50 p-6 rounded-2xl border border-yellow-500/30">
                            <h3 class="text-yellow-400 font-bold mb-3 flex items-center">
                                <span class="mr-2">ğŸ“Š</span> é‚è¼¯åˆ†æ•¸ (Logic Score)
                            </h3>
                            <div class="text-6xl font-black text-white mb-3 tracking-tighter">${logicScore}<span class="text-xl text-gray-500 font-normal ml-2">/100</span></div>
                            <p class="text-sm text-gray-300 leading-relaxed">${parseText(debateCritique)}</p>
                            <p class="text-xs text-gray-500 mt-2">F/O éšæ®µè²¢ç»ï¼š ${gameState.fojScore} åˆ†</p>
                        </div>
                        
                        <div class="bg-gray-800/50 p-6 rounded-2xl border border-purple-500/30">
                            <h3 class="text-purple-400 font-bold mb-3 flex items-center">
                                <span class="mr-2">ğŸ‘¾</span> å°æ‰‹ç‹€æ…‹ (Target Status)
                            </h3>
                            <div class="flex items-center mb-4 bg-black/20 p-3 rounded-xl">
                                <span class="text-4xl mr-3 emoji-icon">${boss.icon}</span>
                                <!-- Display Age in final status -->
                                <span class="text-white font-bold text-lg">${boss.name} <span class="text-sm text-gray-400 ml-2">(${boss.age}æ­², ${boss.job})</span></span>
                            </div>
                            <p class="text-white italic text-sm border-l-2 border-purple-500 pl-3">"${parseText(finalBossVerdict)}"</p>
                            <p class="text-xs text-gray-500 mt-2 text-right">é›£åº¦: ${difficulty.name} | æœ€çµ‚å£«æ°£: ${gameState.bossMorale}%</p>
                        </div>
                    </div>
                    
                    <!-- Suggestions Section -->
                    <div class="mt-6 bg-indigo-900/30 p-6 rounded-2xl border border-indigo-500/30 text-left">
                        <h3 class="text-indigo-400 font-bold mb-3 flex items-center">
                            <span class="mr-2">ğŸ’¡</span> è¾¯è«–å„ªåŒ–å»ºè­° (Tactical Advice)
                        </h3>
                        <ul class="list-disc pl-5 space-y-2 text-gray-300 text-sm leading-relaxed">
                            ${debateSuggestions ? debateSuggestions.map(s => `<li>${parseText(s)}</li>`).join('') : '<li>ç„¡å…·é«”å»ºè­°</li>'}
                        </ul>
                    </div>

                    <button onclick="window.location.reload()" class="mt-10 soft-btn px-10 py-5 text-xl font-bold shadow-xl">
                        é‡æ–°å•Ÿå‹•ç³»çµ± (REBOOT)
                    </button>
                </div>
            `;
            stages[5].innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', () => {
            stageDisplay = document.getElementById('current-stage-display');
            gameContent = document.getElementById('game-container');
            loadingState = document.getElementById('loading-state');
            errorState = document.getElementById('error-state');
            errorMessageDetail = document.getElementById('error-message-detail');
            loadingMessage = document.getElementById('loading-message');
            
            stages = {
                0: document.getElementById('stage-0'),
                1: document.getElementById('stage-1'),
                2: document.getElementById('stage-2'), 
                3: document.getElementById('stage-3'), 
                4: document.getElementById('stage-4'), 
                5: document.getElementById('stage-5'), 
            };

            // Setup Listeners
            document.getElementById('bgm-toggle').addEventListener('click', () => {
                if (!isAudioInitialized) initializeAudio();
                else isBGMPlaying ? stopBGM() : startBGM();
            });

            document.getElementById('instructions-button').addEventListener('click', () => {
                playClickSFX();
                displayModal('éŠæˆ²èªªæ˜èˆ‡ç›®æ¨™', 
                    `<div class="space-y-4">
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 0: é¸æ“‡æˆ°å ´</h4>
                            <p class="text-sm">é¸æ“‡ä¸€å€‹ä½ æ„Ÿèˆˆè¶£çš„çˆ­è­°è©±é¡Œï¼Œæˆ–è¼¸å…¥ä¸€ç¯‡è²¼æ–‡ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 1: é‚è¼¯æ‹†è§£ (äº‹å¯¦/è§€é»)</h4>
                            <p class="text-sm">åˆ†ææ–‡ä¸­çš„å¥å­æ˜¯äº‹å¯¦æˆ–è§€é»ï¼Œæ¯ç­”å°ä¸€é¡Œå¯ç²å¾— **20 åˆ†**çš„åŸºç¤åˆ†æ•¸ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 2: è§’è‰²æ¨¡æ“¬</h4>
                            <p class="text-sm">æ›ä½æ€è€ƒã€‚æ‰®æ¼”ä¸€å€‹ç‰¹å®šç«‹å ´çš„è§’è‰²ï¼Œæ¨¡æ“¬ç™¼è¨€ã€‚è¡¨ç¾å„ªç•°å°‡å½±éŸ¿æœ€çµ‚ç¸½åˆ†ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-emerald-400 font-bold mb-1">Step 3: è¼¿è«–è§€å¯Ÿ</h4>
                            <p class="text-sm">è§€å¯Ÿå ´ä¸Šä¸åŒè§’è‰²çš„ç™¼è¨€ï¼Œè’é›†æƒ…å ±ï¼Œä¸¦è¤‡ç¿’é—œéµè¡“èªã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-red-400 font-bold mb-1">Step 4: é­”ç‹æˆ° (éµç›¤å°å³™)</h4>
                            <p class="text-sm">é¢å°ä¸€å€‹ã€Œæ²’çœ‹å…§æ–‡å°±é–‹å™´ã€çš„é…¸æ°‘ã€‚ç›®æ¨™æ˜¯é€é**é‚è¼¯åæ“Š**å°‡å…¶å£«æ°£é™è‡³é›¶ã€‚å›åˆæ¨¡å¼ä¸‹ï¼Œé”åˆ°é›£åº¦è¨­å®šçš„å£«æ°£å‰Šå¼±é–€æª»å³å¯ç²å‹ã€‚</p>
                        </div>
                        <div class="bg-gray-700/30 p-3 rounded-xl">
                            <h4 class="text-purple-400 font-bold mb-1">Step 5: çµç®—</h4>
                            <p class="text-sm">AI è£åˆ¤å°‡ç¶œåˆ F/O è¡¨ç¾å’Œé­”ç‹æˆ°çµæœï¼Œçµ¦å‡ºä½ çš„æœ€çµ‚é‚è¼¯å¼·åº¦è©•åˆ†ã€‚</p>
                        </div>
                    </div>`);
            });

            if (!apiKey) {
                displayError("SYSTEM HALTED: API KEY MISSING");
                return;
            }

            renderStage0();
            showStage(0);
        });
    </script>
</body>
</html>